<!DOCTYPE html>
<html lang="id">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ujian Online V.3 | Ujian Online</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  
<style>
    /* --- FONTS & GLOBAL --- */
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #f8fafc; /* Slate 50 */
      color: #334155; /* Slate 700 */
      user-select: none; 
      overflow-x: hidden;
    }
    
    h1, h2, h3, h4, h5, h6, .font-heading {
      font-family: 'Poppins', sans-serif;
    }

    /* --- UTILITIES --- */
    .glass {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
    }
    
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(10px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* --- SIDEBAR STYLES --- */
/* --- SIDEBAR STYLES --- */
    .sidebar-bg {
        background: #2b369e; /* Warna baru sesuai permintaan */
        border-right: 1px solid rgba(0, 0, 0, 0.1); /* Border lebih halus menyatu dengan biru */
        color: #e0e7ff; /* Warna teks diperterang (Indigo-50) agar kontras dengan background biru */
    }
    
    .sidebar-item {
        position: relative;
        display: flex;
        align-items: center;
        padding: 12px 16px;
        margin-bottom: 4px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        overflow: hidden;
        white-space: nowrap;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .sidebar-item:hover { 
        background: rgba(255,255,255,0.08); 
        color: #f1f5f9; 
    }
    
    .sidebar-item.active { 
        background: #2563eb; /* Blue 600 */
        color: #fff; 
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); 
    }
    
    .sidebar-item i { 
        width: 24px; 
        text-align: center; 
        margin-right: 12px; 
        font-size: 1.1rem; 
        flex-shrink: 0; 
        transition: transform 0.2s;
    }

    .sidebar-item:hover i { transform: scale(1.1); }
    
    /* Logika Collapse Sidebar */
    #admin-sidebar.collapsed { width: 80px; }
    #admin-sidebar.collapsed .sidebar-text, 
    #admin-sidebar.collapsed .user-info-text,
    #admin-sidebar.collapsed .sidebar-header-text,
    #admin-sidebar.collapsed .section-label { display: none; }
    
    #admin-sidebar.collapsed .sidebar-item { justify-content: center; padding: 12px 0; }
    #admin-sidebar.collapsed .sidebar-item i { margin-right: 0; }
    #admin-sidebar.collapsed .user-info-avatar { margin-right: 0; width: 40px; height: 40px; }

    /* --- MODERN DASHBOARD CARDS (Fix Full Width) --- */
    .dash-card {
        background: #ffffff;
        border-radius: 16px;
        border: 1px solid #e2e8f0; /* Slate 200 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        
        /* PENTING: Padding 0 agar konten/tabel bisa full width */
        padding: 0; 
        
        overflow: hidden; /* Agar sudut konten mengikuti radius card */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        display: flex;
        flex-direction: column;
    }
    
    .dash-card:hover { 
        transform: translateY(-3px); 
        box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.06), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
        border-color: #cbd5e1;
    }
    
    /* Ikon Stat Card */
    .stat-card-icon {
        width: 48px; height: 48px;
        border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem;
        transition: transform 0.3s ease;
    }
    .dash-card:hover .stat-card-icon { transform: scale(1.1) rotate(6deg); }

    /* --- MODERN TABLE STYLES --- */
    .table-modern { width: 100%; border-collapse: separate; border-spacing: 0; }
    
    .table-modern thead th {
        background-color: #f8fafc;
        color: #64748b;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 16px; /* Padding header tabel */
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
    }
    /* Rounded corners untuk header tabel */
    .table-modern thead th:first-child { border-top-left-radius: 0px; } 
    .table-modern thead th:last-child { border-top-right-radius: 0px; }
    
    .table-modern tbody td {
        padding: 16px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        color: #334155;
    }
    .table-modern tbody tr:last-child td { border-bottom: none; }
    .table-modern tbody tr:hover { background-color: #f8fafc; }

    /* --- BADGES & CHIPS --- */
    .badge {
        display: inline-flex; align-items: center;
        padding: 4px 10px;
        border-radius: 9999px;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.025em;
        text-transform: uppercase;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }

    /* --- TIMELINE --- */
    .timeline-item { position: relative; padding-left: 24px; padding-bottom: 24px; border-left: 2px solid #e2e8f0; }
    .timeline-item:last-child { border-left-color: transparent; padding-bottom: 0; }
    .timeline-dot {
        position: absolute; left: -6px; top: 0;
        width: 10px; height: 10px; border-radius: 50%;
        background: #cbd5e1; border: 2px solid #fff;
        box-shadow: 0 0 0 2px #f1f5f9;
        transition: all 0.2s;
    }
    .timeline-item:hover .timeline-dot { background: #3b82f6; transform: scale(1.3); }

    /* --- UTILITIES GRADIENT --- */
    .bg-gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .bg-gradient-purple { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
    .bg-gradient-emerald { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .bg-gradient-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; }


    .cbt-secure-badge {
        position: static; /* Tidak melayang lagi */
        transform: none;
        background: transparent; /* Hapus latar belakang gelap */
        color: #94a3b8; /* Warna teks abu-abu (Slate 400) agar elegan */
        padding: 0;
        margin-top: 25px; /* Jarak dari tombol login */
        width: 100%;
        display: flex; 
        align-items: center; 
        justify-content: center; /* Posisi tengah */
        gap: 6px;
        font-family: monospace;
        font-size: 11px;
        font-weight: 500;
        pointer-events: none;
        border: none;
        box-shadow: none;
        backdrop-filter: none;
    }
    
    /* Ikon Perisai tetap terlihat bagus */
    .cbt-secure-badge i {
        color: #f59e0b; /* Kuning emas */
        font-size: 12px;
    }

      @media (max-width: 640px) {
        .cbt-secure-badge {
            font-size: 9px !important;    /* Font kecil */
            padding: 4px 12px !important; /* Padding tipis */
            gap: 5px !important;
            bottom: 4px !important;       /* Posisi diturunkan (semula 15px) */
            max-width: 85% !important;    /* Mencegah melebar ke pinggir */
        }
    }

    #page-login {
        background-color: #0f172a; /* Fallback */
    }

/* --- MODERN EXAM UI UPDATE --- */
    
    /* 1. Header Gradient & Glass */
    .exam-header {
        background: #2b369e; /* Warna Biru Sidebar Admin */
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: white; /* Teks jadi putih */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* 2. Timer Capsule */
    .timer-capsule {
            background: rgba(0, 0, 0, 0.25); /* Semi transparan gelap */
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #facc15; 
            padding: 6px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Courier New', monospace;
        }

    /* 3. Question Card & Typography */
    .question-card {
        background: white;
        border-radius: 20px; /* Lebih bulat modern */
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
        border: 1px solid #f1f5f9;
        overflow: hidden;
    }
    
    .question-text {
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        color: #1e293b;
        line-height: 1.8;
    }

    /* 4. Modern Option (Radio Button Replacement) */
    .option-label {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        border: 2px solid #e2e8f0; /* Border default halus */
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        background: #fff;
        position: relative;
    }

    .option-label:hover {
        background-color: #f8fafc;
        border-color: #cbd5e1;
        transform: translateY(-1px);
    }

    /* State ketika dipilih (Checked) */
    .option-label.checked {
        border-color: #3b82f6; /* Blue 500 */
        background-color: #eff6ff; /* Blue 50 */
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    /* Custom Radio Circle */
    .custom-radio {
        width: 22px;
        height: 22px;
        border: 2px solid #cbd5e1;
        border-radius: 50%;
        margin-right: 16px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        background: white;
    }
    
    .option-label.checked .custom-radio {
        border-color: #3b82f6;
        background: #3b82f6;
    }

    .custom-radio::after {
        content: '';
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.2s;
    }

    .option-label.checked .custom-radio::after {
        transform: scale(1);
    }

    /* 5. Navigation Sidebar Compact */
    .nav-btn-modern {
        width: 36px;  /* Ukuran fix kecil */
        height: 36px;
        font-size: 0.75rem; /* Text kecil */
        border-radius: 8px; /* Sedikit rounded */
        font-weight: 600;
        transition: all 0.2s;
        border: 1px solid #e2e8f0;
        color: #64748b;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-btn-modern:hover {
        border-color: #94a3b8;
        color: #334155;
    }

    /* Active / Current Question */
    .nav-btn-modern.current {
        border: 2px solid #f59e0b; /* Amber/Yellow border */
        background: #fffbeb;
        color: #d97706;
        transform: scale(1.1);
        z-index: 10;
        box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
    }

    /* Answered */
    .nav-btn-modern.answered {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    /* --- ANIMATION HELPERS --- */
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="iframe-container">
	<iframe
	id="app"
	src="https://script.google.com/macros/s/AKfycbzuHpWopVqbTTx71UB4kmrnnvx_1zSqcFfD2ETd9RylTIsQMby_b8N3DTzlYoU-6eVW/exec"
	scrolling="yes"
	allowfullscreen="true"
	webkitallowfullscreen="true"
  

<div id="page-login" class="flex items-center justify-center min-h-screen bg-cover bg-center relative p-4" 
     style="background-image: url('<?= cfg.app_background || "https://images.unsplash.com/photo-1562774053-701939374585?q=80&w=1986&auto=format&fit=crop" ?>');">
      
      <div class="absolute inset-0 bg-black/60 z-0"></div>

      <div class="glass w-full max-w-md p-8 rounded-2xl shadow-2xl fade-in relative z-10 overflow-hidden">
        <div class="text-center mb-8 relative z-10">
          
          <div class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-white mb-6 shadow-xl ring-4 ring-blue-50 p-4 transform hover:scale-105 transition duration-500">
            <img id="login-logo-img" 
                 src="<?= cfg.app_logo ?>" 
                 class="w-full h-full object-contain filter drop-shadow-sm" 
                 alt="Logo Aplikasi"
                 onerror="this.src='https://via.placeholder.com/150?text=Logo'">
          </div>

          <h1 id="login-title" class="text-3xl font-bold text-slate-800 tracking-tight"><?= cfg.app_name ?></h1>
          <p id="login-subtitle" class="text-sm text-slate-600 mt-2 font-medium"><?= cfg.app_subtitle ?></p>
        </div>
        
        <form id="loginForm" onsubmit="handleLogin(event)" class="relative z-10 space-y-5">
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">User ID</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500"><i class="fas fa-id-card"></i></span>
              <input type="text" id="username" class="pl-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-blue-600 bg-white" placeholder="Masukkan User ID (Contoh: SIS-001)" required>
            </div>
          </div>
          
          <div>
            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Password</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500"><i class="fas fa-lock"></i></span>
              <input type="password" id="password" class="pl-10 pr-10 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 focus:border-blue-600 bg-white transition" placeholder="••••••••" required>
              
              <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-gray-500 hover:text-blue-600 transition select-none" onclick="togglePasswordVisibility()" title="Tampilkan/Sembunyikan Password">
                  <i class="fas fa-eye" id="icon-toggle-pass"></i>
              </span>
            </div>
          </div>

          <div id="pin-container">
            <label class="block text-xs font-bold text-red-600 uppercase tracking-wide mb-1">PIN Sesi Ujian</label>
            <div class="relative">
              <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-red-500"><i class="fas fa-key"></i></span>
              <input type="text" id="pin" class="pl-10 block w-full px-4 py-3 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 bg-red-50 tracking-widest font-bold text-slate-800" placeholder="Contoh: 123456" required>
            </div>
          </div>
          
          <div class="flex items-center justify-between">
            <label class="flex items-center cursor-pointer select-none">
              <input type="checkbox" id="isAdmin" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" onchange="togglePinInput()">
              <span class="ml-2 text-sm text-slate-700 font-semibold">Login sebagai Admin / Guru</span>
            </label>
          </div>

          <button type="submit" id="btnLogin" class="w-full bg-blue-700 hover:bg-blue-800 text-white py-3 rounded-lg font-bold shadow-lg transform transition active:scale-95 flex justify-center items-center gap-2">
            <span>Masuk Aplikasi</span> <i class="fas fa-arrow-right"></i>
          </button>

          <div id="loginError" class="p-3 rounded-lg bg-red-100 text-red-700 text-sm text-center hidden border border-red-200 font-medium">
            <span id="errorText">Error message here</span>
          </div>
          
        </form>
      </div>
    </div>

    <div id="page-admin" class="hidden flex h-screen bg-slate-100 overflow-hidden">
      
      <aside id="admin-sidebar" class="sidebar-bg w-72 h-full flex flex-col fixed md:relative z-40 transition-all duration-300 shadow-xl transform -translate-x-full md:translate-x-0">
        
        <div class="h-20 flex items-center justify-center border-b border-slate-700/50 px-6" style="background-color: #0f172a;">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                <i class="fas fa-graduation-cap text-xl"></i>
            </div>
            <div class="sidebar-header-text">
                <h1 class="text-white font-bold text-lg tracking-tight"><?= cfg.app_name ?></h1>
                <p class="text-xs text-slate-400">Admin Panel v2.0</p>
            </div>
          </div>
        </div>

        <div class="px-4 py-6 border-b border-slate-700/50">
           <div class="bg-slate-800/50 rounded-xl p-3 flex items-center gap-3 border border-slate-700">
             <div class="user-info-avatar w-10 h-10 rounded-full bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white font-bold shadow-md shrink-0">
                 A
              </div>
              <div class="user-info-text overflow-hidden">
                 <p class="text-white text-sm font-semibold truncate" id="admin-sidebar-name">Administrator</p>
                 <div class="flex items-center gap-1 text-[10px] text-emerald-400">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> Online
                 </div>
              </div>
           </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
          <p class="section-label px-4 text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-2 mt-2">Main Menu</p>
          
          <div class="sidebar-item active" onclick="showAdminTab('dash-home', this)">
             <i class="fas fa-home"></i> <span class="sidebar-text font-medium">Dashboard</span>
          </div>
          
          <div class="sidebar-item" onclick="showAdminTab('dash-exams', this)">
            <i class="fas fa-calendar-days"></i> <span class="sidebar-text font-medium">Jadwal Ujian</span>
          </div>
          
          <div class="sidebar-item" onclick="showAdminTab('dash-questions', this)">
             <i class="fas fa-book"></i> <span class="sidebar-text font-medium">Bank Soal</span>
          </div>
          
          <div class="sidebar-item" onclick="showAdminTab('dash-results', this)">
             <i class="fas fa-chart-bar"></i> <span class="sidebar-text font-medium">Hasil & Nilai</span>
          </div>

          <div id="menu-users" class="sidebar-item" onclick="showAdminTab('dash-users', this)">
              <i class="fas fa-users-cog"></i> <span class="sidebar-text font-medium">Manajemen User</span>
          </div>

          <div id="menu-images" class="sidebar-item" onclick="showAdminTab('dash-images', this)">
              <i class="fas fa-images"></i> <span class="sidebar-text font-medium">Folder Gambar</span>
          </div>

          <div id="menu-config" class="sidebar-item" onclick="showAdminTab('dash-config', this)">
              <i class="fas fa-cogs"></i> <span class="sidebar-text font-medium">Konfigurasi</span>
          </div>

        </nav>

        <div class="p-4 border-t border-slate-700/50">
           <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-lg text-sm font-medium text-red-200 bg-red-900/20 hover:bg-red-600 hover:text-white transition-all border border-red-900/30 sidebar-item">
             <i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Keluar</span>
          </button>
        </div>
      </aside>

      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-200 h-20 flex items-center justify-between px-6 z-30 sticky top-0">
          <div class="flex items-center gap-4">
             <button class="md:hidden text-slate-500 hover:text-blue-600 transition" onclick="toggleMobileSidebar()">
                 <i class="fas fa-bars text-xl"></i>
             </button>
             
             <button class="hidden md:flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 text-slate-600 hover:bg-blue-100 hover:text-blue-600 transition" onclick="toggleDesktopSidebar()">
                <i class="fas fa-indent text-sm" id="collapse-icon"></i>
             </button>

             <h2 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block" id="admin-header-title">Dashboard Overview</h2>
          </div>

          <div class="flex items-center gap-4">
             <div class="hidden sm:block text-right">
                <div class="text-xs text-slate-400 font-medium" id="current-date-display">Senin, 1 Jan 2024</div>
             </div>
             <div class="h-8 w-px bg-slate-200 hidden sm:block"></div>
             <button class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-slate-200 transition relative">
                <i class="fas fa-bell"></i>
                <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
             </button>
          </div>
        </header>

        <main class="flex-1 overflow-auto p-6 md:p-8 bg-slate-50 relative" id="admin-content">
          <div class="flex flex-col items-center justify-center h-full text-slate-400">
            <div class="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
            <p>Memuat data...</p>
          </div>
        </main>
      </div>
      
      <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass" onclick="toggleMobileSidebar()"></div>

      <div id="modal-grading" class="fixed inset-0 z-50 hidden flex items-center justify-center">
          <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeGradingModal()"></div>
         
           <div class="relative w-full max-w-2xl p-4">
              <div class="bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out]">
                  <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
                      <div>
                          <h3 class="font-bold text-lg text-slate-800">Koreksi Jawaban Esai</h3>
                          <p class="text-xs text-slate-500" id="grading-student-name">Nama Siswa</p>
                      </div>
                      <button onclick="closeGradingModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                  </div>
                  
                  <div class="p-6 overflow-y-auto" id="grading-content">
                      <div class="flex justify-center py-10"><i class="fas fa-circle-notch fa-spin text-blue-500 text-2xl"></i></div>
                  </div>

                  <div class="p-4 border-t bg-slate-50">
                      <div class="flex items-center justify-between mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                          <span class="text-sm font-bold text-yellow-800">Total Poin Tambahan (Esai):</span>
                          <input type="number" id="input-essay-score" class="w-24 p-2 border border-slate-300 rounded text-right font-bold focus:ring-2 focus:ring-blue-500 outline-none" placeholder="0">
                      </div>
                      <button onclick="submitEssayGrade()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition active:scale-95">
                          <i class="fas fa-save mr-2"></i> Simpan & Hitung Ulang Nilai
                      </button>
                 </div>
              </div>
          </div>
      </div>
    </div>

    <div id="page-exam" class="hidden h-screen flex flex-col bg-slate-50 font-sans">
      
      <header class="exam-header h-16 px-4 md:px-6 py-3 flex items-center justify-between z-30 shrink-0 sticky top-0 bg-[#2b369e] text-white shadow-md">
        
        <div class="flex items-center gap-3 overflow-hidden mr-2">
          <div class="hidden md:flex items-center justify-center w-10 h-10 rounded-xl bg-white/10 text-white shadow-sm border border-white/20 shrink-0">
            <i class="fas fa-book-open text-lg"></i>
          </div>
          
          <div class="flex flex-col min-w-0">
            <h1 class="font-bold text-white text-sm md:text-lg leading-tight truncate" id="exam-subject-title">
                Memuat Ujian...
            </h1>
            <div class="flex items-center gap-2 text-[10px] md:text-xs font-medium text-blue-100 mt-0.5 truncate">
               <span class="bg-white/10 px-1.5 py-0.5 rounded text-white border border-white/10 shrink-0" id="student-id-display">ID</span>
               <span class="truncate" id="student-name-display">Siswa</span>
            </div>
          </div>
        </div>

        <div class="absolute left-1/2 transform -translate-x-1/2 hidden md:flex">
             <div class="timer-capsule px-4 py-1.5 rounded-lg bg-black/20 border border-white/10 flex items-center gap-2">
                 <i class="fas fa-stopwatch animate-pulse text-yellow-400"></i>
                 <span id="timer-display" class="font-mono font-bold text-lg text-yellow-300">00:00:00</span>
             </div>
        </div>

        <div class="flex items-center gap-2 shrink-0">
            <div class="md:hidden flex flex-col items-center justify-center bg-black/20 px-2 py-1 rounded border border-white/10 min-w-[50px]">
                <span class="text-[8px] text-blue-200 uppercase tracking-wider leading-none mb-0.5">Sisa</span>
                <span id="timer-display-mobile" class="font-mono font-bold text-yellow-300 text-sm leading-none">00:00</span>
            </div>

            <button onclick="finishExamManual()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-2 md:px-5 md:py-2 rounded-lg md:rounded-xl text-xs md:text-sm font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2 border border-emerald-400">
               <span class="hidden sm:inline">Selesai</span> <i class="fas fa-check"></i>
            </button>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden relative">
        
        <main class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth" id="main-exam-area">
          <div class="max-w-7xl mx-auto pb-24"> 
            
            <div id="question-container" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 md:p-8 fade-in min-h-[400px] relative">
               <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                   <i class="fas fa-circle-notch fa-spin text-3xl mb-2"></i>
                   <p>Menyiapkan soal...</p>
               </div>
            </div>

            <div class="flex justify-between items-center mt-6">
                <button onclick="prevQ()" id="btn-prev" class="px-5 py-2.5 rounded-xl font-bold text-sm text-slate-500 hover:bg-white hover:text-slate-700 hover:shadow-md transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed border border-transparent hover:border-slate-200">
                    <i class="fas fa-arrow-left"></i> Sebelumnya
                </button>
                <button onclick="nextQ()" id="btn-next" class="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-lg shadow-blue-600/20 font-bold text-sm transition transform active:scale-95 flex items-center gap-2">
                     Selanjutnya <i class="fas fa-arrow-right"></i>
                </button>
            </div>

          </div>
        </main>

        <aside id="exam-nav" class="w-72 bg-white border-l border-slate-200 flex flex-col z-20 shadow-2xl absolute right-0 h-full transform translate-x-full md:relative md:translate-x-0 transition-transform duration-300">
           
           <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 class="font-bold text-slate-800 text-xs uppercase tracking-wide">Navigasi Soal</h3>
                <p class="text-[10px] text-slate-400">Klik nomor untuk pindah</p>
            </div>
            <button class="md:hidden text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50" onclick="toggleExamNav()">
                <i class="fas fa-times text-lg"></i>
            </button>
          </div>
          
          <div class="flex-1 overflow-y-auto p-4 custom-scrollbar">
            <div id="nav-grid" class="grid grid-cols-5 gap-2 content-start"></div>
            
             <div class="mt-6 space-y-2 border-t border-slate-100 pt-4">
                <div class="flex items-center gap-2 text-[10px] text-slate-600">
                   <div class="w-3 h-3 rounded bg-blue-600 shadow-sm"></div> Dijawab
                </div>
                <div class="flex items-center gap-2 text-[10px] text-slate-600">
                   <div class="w-3 h-3 rounded border-2 border-amber-500 bg-amber-50"></div> Sedang Dikerjakan
                </div>
                <div class="flex items-center gap-2 text-[10px] text-slate-600">
                    <div class="w-3 h-3 rounded border border-slate-300 bg-white"></div> Belum Dijawab
                </div>
            </div>
          </div>
        </aside>

      </div>
      
      <button class="md:hidden fixed bottom-6 right-6 bg-slate-800 text-white w-12 h-12 rounded-full shadow-xl shadow-slate-900/40 flex items-center justify-center z-40 transform active:scale-90 transition" onclick="toggleExamNav()">
        <i class="fas fa-th-large"></i>
      </button>

    </div>

  </div> 

  <div id="warning-overlay" class="fixed inset-0 bg-red-900/95 z-[100] flex items-center justify-center text-white p-6 text-center backdrop-blur-md hidden">
    <div class="max-w-lg w-full border-4 border-yellow-400 p-8 rounded-2xl bg-red-800 shadow-2xl animate-pulse">
      <i class="fas fa-hand-paper text-6xl text-yellow-400 mb-6"></i>
      <h2 class="text-4xl font-extrabold mb-4 uppercase tracking-widest">PERINGATAN!</h2>
      <p class="text-xl font-bold mb-2">DILARANG BERALIH TAB / MEMINIMIZE LAYAR</p>
      <p class="text-red-200 mb-6 text-sm">Sistem mendeteksi aktivitas mencurigakan.</p>
      <div class="bg-black/30 p-4 rounded-lg mb-6 border border-white/20">
        <p class="text-yellow-300 font-bold uppercase text-lg">JIKA DILAKUKAN SEKALI LAGI,<br>UJIAN OTOMATIS SELESAI.</p>
      </div>
      <button onclick="resumeExamFromViolation()" class="w-full bg-yellow-400 text-red-900 px-8 py-4 rounded-xl font-extrabold text-xl hover:bg-yellow-300 transition shadow-lg transform hover:scale-105">
        SAYA PAHAM & KEMBALI UJIAN
      </button>
    </div>
  </div>

  <div id="global-loading" class="fixed inset-0 bg-white/80 z-[60] flex items-center justify-center hidden">
    <div class="text-center">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600 mb-3"></i>
        <p class="text-slate-600 font-medium">Memproses...</p>
    </div>
  </div>



  <script>

    (function(){
        const _idArr = [109,106,45,115,101,99,117,114,101,45,102,111,111,116,101,114];
        const _txtArr = [169, 32, 67, 111, 112, 121, 114, 105, 103, 104, 116, 32, 77, 74, 32, 79, 102, 102, 105, 99, 105, 97, 108, 32, 66, 75, 76];
        const _dec = (arr) => String.fromCharCode(...arr);
        setInterval(() => {
            const _id = _dec(_idArr);
            const _el = document.getElementById(_id);
            if (!_el) {
                const _d = document.createElement('div');
                _d.id = _id; 
                _d.className = 'cbt-secure-badge'; 
                // Ikon & Teks
                _d.innerHTML = '<i class="fas fa-shield-alt"></i> <span>' + _dec(_txtArr) + '</span>';
                
                // --- PERUBAHAN DISINI: Target ke 'loginForm' ---
                const targetContainer = document.getElementById('loginForm');
                if (targetContainer) {
                    targetContainer.appendChild(_d);
                }
            }
        }, 1500);
    })();

    let currentUser = null;
    let currentExam = null;
    let questions = [];
    let answers = {};
    let currentQIndex = 0;
    let violationCount = 0;
    let timerInterval;
    let cachedExams = []; 
    let selectedLeft = null;
    let ac_ctxHandler, ac_keyHandler, ac_visHandler, ac_blurHandler, ac_fsHandler, ac_unloadHandler;
    let currentGradingId = null;
    let allResultsData = [];    // Menyimpan semua data mentah dari server
    let filteredResults = [];   // Menyimpan data setelah difilter pencarian
    let currentPage = 1;        // Halaman aktif saat ini
    let rowsPerPage = 10;       // Default jumlah baris
    let allQuestionsData = [];
    let filteredQuestions = [];
    let currentQPage = 1;
    let qRowsPerPage = 10;
    let cachedUsers = [];
    let allUsersData = [];
    let filteredUsers = [];
    let currentUserPage = 1;
    let userRowsPerPage = 10;
    let masterData = { classes: [], subjects: [] };
    let initialExamHTML = '';
    // --- UI HELPERS ---
    function toggleDesktopSidebar() {
        const sidebar = document.getElementById('admin-sidebar');
        const icon = document.getElementById('collapse-icon');
        sidebar.classList.toggle('collapsed');
        if(sidebar.classList.contains('collapsed')) {
            icon.className = 'fas fa-outdent text-sm';
        } else {
            icon.className = 'fas fa-indent text-sm';
        }
    }

    function toggleMobileSidebar() {
        const sidebar = document.getElementById('admin-sidebar');
        const overlay = document.getElementById('mobile-overlay');
        sidebar.classList.toggle('-translate-x-full');
        if(sidebar.classList.contains('-translate-x-full')) {
            overlay.classList.add('hidden');
        } else {
            overlay.classList.remove('hidden');
        }
    }

    function setDateDisplay() {
        const d = new Date();
        const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date-display').innerText = d.toLocaleDateString('id-ID', opts);
    }

    // --- 1. AUTHENTICATION ---
      function togglePinInput() {
      // Ambil status apakah Admin dicentang
      const isAdmin = document.getElementById('isAdmin').checked;
      const pinContainer = document.getElementById('pin-container');
      const pinInput = document.getElementById('pin');

      if (isAdmin) {
          // JIKA ADMIN (Dicentang): Sembunyikan PIN
          pinContainer.classList.add('hidden'); 
          pinInput.removeAttribute('required'); // PIN tidak wajib
          pinInput.value = ''; // Bersihkan input PIN agar rapi
      } else {
          // JIKA SISWA (Tidak Dicentang): Tampilkan PIN
          pinContainer.classList.remove('hidden'); 
          pinInput.setAttribute('required', 'true'); // PIN wajib diisi
      }
    }

function handleLogin(e) {
        e.preventDefault();
        
        // 1. Ambil nilai dari Form
        const user = document.getElementById('username').value;
        const pass = document.getElementById('password').value;
        const pin = document.getElementById('pin').value;
        
        // Logika Baru: Siswa adalah ketika Admin TIDAK dicentang
        const isAdmin = document.getElementById('isAdmin').checked;
        const isStudent = !isAdmin; 

        // 2. Ambil elemen UI untuk Loading
        const btn = document.getElementById('btnLogin');
        const errDiv = document.getElementById('loginError');
        const errText = document.getElementById('errorText');

        // 3. Set status Loading
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Memverifikasi...';
        errDiv.classList.add('hidden');

        // 4. Panggil Fungsi Server (loginUser)
        // Jika isStudent true, kirim PIN. Jika tidak, kirim null.
        google.script.run.withSuccessHandler(res => {
            // Reset tombol
            btn.disabled = false;
            btn.innerHTML = '<span>Masuk Aplikasi</span> <i class="fas fa-arrow-right"></i>';

            if (res.success) {
                // === SIMPAN SESI KE LOCAL STORAGE ===
                localStorage.setItem('sipadu_session', JSON.stringify({
                    userID: res.userID,
                    token: res.token,
                    role: res.role,
                    username: res.username
                }));

                // Set variabel global
                currentUser = res;

                // Logika Redirect Halaman
                if (res.role === 'Admin' || res.role === 'Guru') {
                    initAdminPanel();
                } else {
                    initStudentExam(res.examData);
                }
            } else {
                // Tampilkan Pesan Error
                errText.textContent = res.message;
                errDiv.classList.remove('hidden');
            }
        }).withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = 'Coba Lagi';
            Swal.fire('Error', 'Terjadi kesalahan koneksi server: ' + err, 'error');
        }).loginUser(user, pass, pin, isAdmin);
    }

function logout() {
        Swal.fire({
            title: 'Keluar?',
            text: "Sesi Anda akan diakhiri.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Keluar'
        }).then((result) => {
            if (result.isConfirmed) {
                
                // 1. Matikan sistem Anti-Cheat
                if (typeof disableAntiCheat === 'function') {
                    disableAntiCheat();
                }

                // 2. Hapus Sesi Browser
                localStorage.removeItem('sipadu_session');

                // 3. Logout di Server (Background process)
                if (typeof currentUser !== 'undefined' && currentUser && currentUser.userID) {
                    google.script.run.logoutUser(currentUser.userID);
                }

                // 4. === RESET VARIABEL MEMORI ===
                currentUser = null;
                currentExam = null;
                questions = [];
                answers = {};
                violationCount = 0;
                
                // 5. === RESET TAMPILAN UJIAN (PENTING) ===
                // Kembalikan HTML halaman ujian ke kondisi awal (sebelum tertimpa pesan "Selesai")
                if (initialExamHTML) {
                    document.getElementById('page-exam').innerHTML = initialExamHTML;
                }

                // 6. === RESET TAMPILAN HALAMAN ===
                document.getElementById('page-admin').classList.add('hidden');
                document.getElementById('page-exam').classList.add('hidden');
                document.getElementById('page-login').classList.remove('hidden');
                document.getElementById('global-loading').classList.add('hidden');

                // 7. === RESET FORM LOGIN ===
                const loginForm = document.getElementById('loginForm');
                if(loginForm) loginForm.reset();
                
                // Kembalikan mode login ke default (Siswa)
                const checkAdmin = document.getElementById('isAdmin');
                if(checkAdmin) checkAdmin.checked = false;
                
                document.getElementById('pin-container').classList.remove('hidden'); 
                const pinInput = document.getElementById('pin');
                if(pinInput) {
                    pinInput.value = '';
                    pinInput.setAttribute('required', 'true');
                }

                // 8. Scroll ke atas
                window.scrollTo(0, 0);
            }
        });
    }

    // --- 2. ADMIN PANEL (UPDATED UI) ---
    function initAdminPanel() {
        switchPage('page-admin');
        document.getElementById('admin-sidebar-name').innerText = currentUser.username;
        setDateDisplay();
          
        // Auto Collapse di layar kecil saat init
        if(window.innerWidth < 1024 && window.innerWidth > 768) {
            document.getElementById('admin-sidebar').classList.add('collapsed');
        }

        // --- LOGIKA BARU: Sembunyikan Menu untuk Guru ---
        const restrictedMenus = ['menu-users', 'menu-images', 'menu-config'];
        
        if (currentUser && currentUser.role === 'Guru') {
            // Jika Guru, sembunyikan menu
            restrictedMenus.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden');
            });
        } else {
            // Jika Admin (atau role lain), pastikan menu tampil
            restrictedMenus.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.remove('hidden');
            });
        }
        // ------------------------------------------------

        // Pastikan Modal Ujian Siap
        initExamModalComponent();

        // Kirim UserID & Token untuk mengambil data ujian
        google.script.run.withSuccessHandler(exams => {
            cachedExams = exams;
            showAdminTab('dash-home'); 
        }).getExamList(currentUser.userID, currentUser.token);
    }

    function showAdminTab(tabId, el) {
      if (currentUser && currentUser.role === 'Guru') {
          const restrictedTabs = ['dash-users', 'dash-images', 'dash-config'];
          if (restrictedTabs.includes(tabId)) {
              Swal.fire({
                  title: 'Akses Ditolak',
                  text: 'Menu ini hanya dapat diakses oleh Administrator.',
                  icon: 'error',
                  confirmButtonColor: '#d33'
              });
              return; // Hentikan proses perpindahan tab
          }
      }
      // -------------------------------------------

      // 1. Highlight Menu Sidebar yang Aktif
      if(el) {
          document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
          el.classList.add('active');
      }
      
      const content = document.getElementById('admin-content');
      const title = document.getElementById('admin-header-title');
      
      // 2. Tutup Sidebar Otomatis di Mobile saat menu diklik
      if(window.innerWidth < 768) {
          document.getElementById('admin-sidebar').classList.add('-translate-x-full');
          document.getElementById('mobile-overlay').classList.add('hidden');
      }

      // 3. Tampilkan Animasi Loading Sementara
      content.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400 fade-in"><i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> Memuat data...</div>';

      // 4. Logika Pindah Halaman (Switch Case)
      if (tabId === 'dash-home') {
        title.innerText = 'Dashboard Overview';
        renderAdminHome(content);

      } else if (tabId === 'dash-exams') {
        title.innerText = 'Manajemen Jadwal Ujian';
        renderExamForm(content);

      } else if (tabId === 'dash-questions') {
        title.innerText = 'Bank Soal';
        renderQuestionBank(content);

      } else if (tabId === 'dash-results') {
        title.innerText = 'Hasil & Nilai';
        renderResults(content);

      } else if (tabId === 'dash-users') { 
        title.innerText = 'Manajemen Pengguna';
        renderUserManagement(content);

      } else if (tabId === 'dash-images') {
        title.innerText = 'Generator Link Gambar';
        renderImageFolder(content);

      } else if (tabId === 'dash-config') {
        title.innerText = 'Konfigurasi Sistem';
        renderConfigPage(content);
      }
    }

function renderAdminHome(container) {
   const totalExams = cachedExams.length;
   const activeExams = cachedExams.filter(e => e.status === 'Aktif' || e.status === 'Open').length;
   const draftExams = totalExams - activeExams;

   // --- LOGIKA BARU: MENGHITUNG JUMLAH MATA PELAJARAN (UNIK) ---
   // 1. Ambil semua nama subject
   // 2. Bersihkan spasi (trim)
   // 3. Masukkan ke Set untuk menghapus duplikat nama mapel
   const uniqueSubjects = [...new Set(cachedExams.map(e => e.subject.trim()))].length;

   container.innerHTML = `
     <div class="fade-in w-full space-y-6">
         
         <div class="dash-card p-6 flex flex-col md:flex-row md:items-center justify-between gap-6">
             <div>
                 <div class="flex items-center gap-3 mb-1">
                    <div class="w-10 h-10 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-md">
                        <i class="fas fa-home"></i>
                    </div>
                    <h2 class="text-xl font-bold text-slate-800 tracking-tight">Dashboard Overview</h2>
                 </div>
                 <p class="text-slate-500 text-sm ml-14">Selamat datang kembali, pantau aktivitas ujian hari ini.</p>
             </div>
             <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                 <div class="hidden lg:block text-right pr-4 border-r border-slate-200">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Hari Ini</p>
                    <p class="text-sm font-bold text-slate-700">
                        ${new Date().toLocaleDateString('id-ID', {weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'})}
                    </p>
                 </div>
                 <div class="flex gap-3 w-full sm:w-auto">
                  <button onclick="refreshDashboard()" class="flex-1 sm:flex-none bg-white border border-slate-200 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-50 hover:text-blue-600 shadow-sm transition flex items-center justify-center gap-2">
                    <i class="fas fa-sync-alt"></i> <span>Refresh</span>
                  </button>
                     <button onclick="openExamModal()" class="flex-1 sm:flex-none bg-blue-600 text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition flex items-center justify-center gap-2 transform active:scale-95">
                        <i class="fas fa-plus"></i> <span>Buat Ujian</span>
                     </button>
                 </div>
             </div>
         </div>

         <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="dash-card p-6 relative group overflow-hidden">
               <div class="flex justify-between items-start z-10 relative">
                   <div>
                       <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Total Jadwal</p>
                       <h3 class="text-3xl font-black text-slate-800">${totalExams}</h3>
                   </div>
                   <div class="stat-card-icon bg-blue-50 text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                       <i class="fas fa-book"></i>
                   </div>
               </div>
               <div class="mt-4 flex items-center text-xs font-medium">
                   <span class="text-blue-600 bg-blue-50 px-2 py-1 rounded-md border border-blue-100 mr-2">
                      <i class="fas fa-check-circle mr-1"></i>${activeExams} Aktif
                   </span>
                   <span class="text-slate-400">${draftExams} Non-Aktif</span>
               </div>
            </div>

            <div class="dash-card p-6 relative group overflow-hidden">
               <div class="flex justify-between items-start z-10 relative">
                   <div>
                       <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Status Peserta</p>
                        <h3 class="text-3xl font-black text-slate-800">Online</h3>
                   </div>
                   <div class="stat-card-icon bg-emerald-50 text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                       <i class="fas fa-users"></i>
                   </div>
               </div>
               <div class="mt-4 flex items-center text-xs font-medium">
                   <span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md border border-emerald-100 mr-2">
                       <i class="fas fa-wifi mr-1"></i>Sistem Stabil
                   </span>
               </div>
            </div>

            <div class="dash-card p-6 relative group overflow-hidden">
               <div class="flex justify-between items-start z-10 relative">
                   <div>
                       <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Bank Soal</p>
                       <h3 class="text-3xl font-black text-slate-800">${uniqueSubjects}</h3>
                   </div>
                   <div class="stat-card-icon bg-purple-50 text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                       <i class="fas fa-database"></i>
                   </div>
               </div>
               <div class="mt-4 text-xs font-medium text-slate-500">
                   <span class="text-purple-600 bg-purple-50 px-2 py-1 rounded-md border border-purple-100 mr-2">
                      <i class="fas fa-layer-group mr-1"></i>Mapel
                   </span>
                   Terdaftar di sistem
               </div>
            </div>

            <div class="dash-card p-6 relative group overflow-hidden">
               <div class="flex justify-between items-start z-10 relative">
                   <div>
                       <p class="text-slate-500 text-[10px] font-extrabold uppercase tracking-widest mb-2">Mode Akses</p>
                       <h3 class="text-2xl font-black text-slate-800 truncate">${currentUser ? currentUser.role : 'Admin'}</h3>
                   </div>
                   <div class="stat-card-icon bg-orange-50 text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                       <i class="fas fa-user-shield"></i>
                   </div>
               </div>
               <div class="mt-4 text-xs font-medium text-slate-500 flex items-center gap-1">
                   <i class="far fa-clock"></i> ${new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})} WIB
               </div>
            </div>
         </div>

         <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 dash-card p-6">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-100">
                    <h3 class="font-bold text-slate-800 text-lg">Aktivitas Terkini</h3>
                    <button class="text-xs text-blue-600 font-bold hover:bg-blue-50 px-3 py-1 rounded-lg transition">Lihat Log Lengkap</button>
                </div>
                <div class="pl-2 space-y-1">
                    <div class="timeline-item">
                        <div class="timeline-dot bg-emerald-500 ring-4 ring-emerald-50"></div>
                        <p class="text-sm font-bold text-slate-700">Login Berhasil</p>
                        <p class="text-xs text-slate-500 mt-1">Anda masuk sebagai Administrator.</p>
                        <span class="text-[10px] font-bold text-slate-400 mt-1 block bg-slate-100 w-fit px-2 rounded">Baru saja</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot bg-blue-500"></div>
                        <p class="text-sm font-bold text-slate-700">Sinkronisasi Data</p>
                        <p class="text-xs text-slate-500 mt-1">Mengambil data ujian terbaru dari database.</p>
                        <span class="text-[10px] font-bold text-slate-400 mt-1 block">1 menit yang lalu</span>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-dot bg-slate-300"></div>
                        <p class="text-sm font-bold text-slate-700">Sistem Siap</p>
                        <p class="text-xs text-slate-500 mt-1">Menunggu interaksi pengguna.</p>
                    </div>
               </div>
            </div>

            <div class="dash-card bg-slate-900 border-slate-800 text-white flex flex-col overflow-hidden">
                <div class="p-6 bg-gradient-to-br from-slate-800 to-slate-900 flex-1">
                    <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                     <i class="fas fa-info-circle text-blue-400"></i> Informasi Penting
                    </h3>
                    <p class="text-slate-400 text-xs mb-6 leading-relaxed border-b border-slate-700 pb-4">
                        Refresh Data setelah melakukan perubahan manual pada Google Spreadsheet.
                    </p>
                    
                    <div class="space-y-3">
                        <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-slate-600 transition">
                            <i class="fas fa-shield-alt text-yellow-400 mt-1"></i>
                            <div>
                                <strong class="block text-sm text-slate-200">Anti-Cheat</strong>
                                <span class="text-[11px] text-slate-500">Aktif otomatis untuk sesi siswa.</span>
                            </div>
                        </div>
                        <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg border border-slate-700 hover:border-slate-600 transition">
                            <i class="fab fa-google-drive text-green-400 mt-1"></i>
                            <div>
                                <strong class="block text-sm text-slate-200">Database</strong>
                                <span class="text-[11px] text-slate-500">Terhubung ke Google Sheets.</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-950 p-3 text-center text-[10px] text-slate-600 font-mono">
                    System v2.0 • Secure Connection
                </div>
            </div>
         </div>
   </div>
   `;
}
    // --- MANAJEMEN UJIAN (TABLE & MODAL) ---
/* --- FUNGSI 2: RENDER HALAMAN JADWAL UJIAN --- */
function renderExamForm(container) {
    // --- 1. SETUP FILTER ---
    window.filterExams = (val) => {
        const rows = document.querySelectorAll('.exam-row');
        rows.forEach(r => {
            const txt = r.innerText.toLowerCase();
            r.style.display = txt.includes(val.toLowerCase()) ? '' : 'none';
        });
    };

    // --- 2. HTML STRUCTURE ---
    let html = `
       <div class="fade-in w-full space-y-4">
          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                  <div>
                      <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                          <i class="fas fa-calendar-alt text-blue-600"></i> Manajemen Jadwal Ujian
                      </h2>
                      <p class="text-sm text-slate-500 mt-1">Kelola jadwal, durasi, dan PIN sesi ujian siswa.</p>
                  </div>
                  <button onclick="openExamModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition flex items-center gap-2 transform active:scale-95 whitespace-nowrap">
                     <i class="fas fa-plus"></i> Buat Jadwal Baru
                  </button>
              </div>

              <div class="relative w-full group">
                 <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-slate-400 group-focus-within:text-blue-500 transition"></i>
                 </div>
                 <input type="text" placeholder="Cari Mata Pelajaran atau Kelas..." onkeyup="filterExams(this.value)" 
                        class="pl-10 pr-4 py-3 w-full border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm bg-slate-50 focus:bg-white text-slate-700">
              </div>
           </div>

           <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div class="overflow-x-auto">
                 <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 text-xs uppercase tracking-wider"> 
                            <th class="w-16 text-center pl-6 py-4 font-bold">No</th> 
                            <th class="py-4 font-bold">Mata Pelajaran & Kelas</th>
                            <th class="py-4 font-bold">Waktu Mulai & Selesai</th>
                            <th class="text-center py-4 font-bold">PIN Sesi</th>
                            <th class="text-center py-4 font-bold">Status</th>
                            <th class="text-right pr-6 py-4 font-bold">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-100">`;

    // --- 3. LOOP DATA ---
    // Pastikan 'cachedExams' sudah terisi data dari getExamList (termasuk endDateStr)
    if (!cachedExams || cachedExams.length === 0) {
        html += `<tr><td colspan="6" class="p-12 text-center text-slate-400">
                    <div class="flex flex-col items-center justify-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300">
                            <i class="fas fa-calendar-times text-3xl"></i>
                        </div>
                        <p class="font-medium">Belum ada jadwal ujian.</p>
                    </div>
                </td></tr>`;
    } else {
        cachedExams.forEach((exam, idx) => {
            // Logic Status Badge
            const isActive = String(exam.status).toLowerCase() === 'aktif';
            const statusBadge = isActive 
                ? `<div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-50 text-emerald-700 border border-emerald-200"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span>AKTIF</div>` 
                : `<div class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500 border border-slate-200"><span class="w-1.5 h-1.5 rounded-full bg-slate-400 mr-1.5"></span>NON-AKTIF</div>`;
            
            const initial = exam.subject ? exam.subject.charAt(0).toUpperCase() : '?';
            
            // --- UPDATE PENTING: TAMPILAN WAKTU SELESAI ---
            const endDateDisplay = exam.endDateStr ? exam.endDateStr : '?';

            html += `
            <tr class="exam-row hover:bg-slate-50 transition group">
                <td class="p-4 pl-6 text-center text-slate-400 font-medium text-xs">${idx + 1}</td>
                
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center font-bold text-lg shadow-sm shrink-0">
                             ${initial}
                        </div>
                        <div>
                            <div class="font-bold text-slate-800 text-sm line-clamp-1" title="${exam.subject}">${exam.subject}</div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-2 py-0.5 rounded border border-slate-200">${exam.class}</span>
                            </div>
                        </div>
                    </div>
                </td>

                <td class="p-4">
                    <div class="flex flex-col gap-1">
                        <div class="text-sm font-medium text-slate-700 flex items-center gap-2">
                             <i class="far fa-calendar-alt text-blue-500 w-4"></i> ${exam.dateStr}
                        </div>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                             <i class="far fa-calendar-check text-slate-400 w-4"></i> Sampai: <span class="text-slate-600 font-medium">${endDateDisplay}</span>
                        </div>
                        <div class="text-xs text-slate-400 flex items-center gap-2 mt-0.5">
                             <i class="far fa-clock text-slate-300 w-4"></i> ${exam.duration} Menit
                        </div>
                    </div>
                </td>

                <td class="p-4 text-center">
                    <div class="font-mono bg-yellow-50 text-yellow-800 px-3 py-1.5 rounded-lg border border-yellow-200 font-bold inline-block select-all text-sm tracking-widest shadow-sm cursor-help" title="PIN Siswa">
                         ${exam.pin}
                    </div>
                </td>

                <td class="p-4 text-center cursor-pointer" onclick="toggleExamStatus('${exam.id}', '${exam.status === 'Aktif' ? 'Non-Aktif' : 'Aktif'}')" title="Klik untuk ubah status">
                    ${statusBadge}
                </td>

                <td class="p-4 pr-6 text-right">
                    <div class="flex justify-end gap-2 opacity-80 group-hover:opacity-100 transition">
                        <button onclick='openExamModal(${JSON.stringify(exam)})' class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white transition flex items-center justify-center shadow-sm border border-indigo-100" title="Edit">
                             <i class="fas fa-pen-to-square text-xs"></i>
                        </button>
                        <button onclick="handleDeleteExam('${exam.id}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center shadow-sm border border-red-100" title="Hapus">
                            <i class="fas fa-trash-can text-xs"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        });
    }
    
    html += `</tbody></table></div></div></div>`;
    
    // Inject HTML
    container.innerHTML = html;

    // --- 4. INIT MODAL (Cek agar tidak duplikat) ---
    if (!document.getElementById('examModal')) {
        initExamModalComponent();
    }
}
/* --- FUNGSI BARU: INISIALISASI MODAL UJIAN SECARA GLOBAL --- */
function initExamModalComponent() {
    // Cek ID 'examModal' (HARUS SAMA dengan yang dicari openExamModal)
    if (!document.getElementById('examModal')) {
        const modalHtml = `
        <div id="examModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeExamModal()"></div>
            
            <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out] z-[101]">
                
                <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 shrink-0 rounded-t-2xl">
                    <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2">
                        <i class="far fa-calendar-alt text-blue-600"></i>
                        <span id="examModalTitle">Jadwal Ujian</span>
                    </h3>
                    <button type="button" onclick="closeExamModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-100 hover:text-red-500 transition focus:outline-none">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="overflow-y-auto p-6 custom-scrollbar">
                    <form id="examForm" onsubmit="handleExamSubmit(event)" class="space-y-5">
                        <input type="hidden" name="examId" id="input-examId">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mata Pelajaran</label>
                                <select name="subject" id="input-subject" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white text-slate-700" required>
                                    <option value="">-- Pilih Mapel --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label>
                                <select name="class" id="input-class" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white text-slate-700" required>
                                    <option value="">-- Pilih Kelas --</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Waktu Mulai</label>
                                <input type="datetime-local" name="date" id="input-date" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-slate-600" required>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Waktu Selesai</label>
                                <input type="datetime-local" name="endDate" id="input-endDate" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm text-slate-600" required>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Durasi (Menit)</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-slate-400"><i class="far fa-clock"></i></span>
                                    <input type="number" name="duration" id="input-duration" class="pl-9 w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="60" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">PIN Sesi</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-yellow-500"><i class="fas fa-key"></i></span>
                                    <input type="text" name="pin" id="input-pin" class="pl-10 w-full bg-yellow-50 border border-yellow-200 p-2.5 rounded-lg font-mono tracking-widest font-bold focus:ring-2 focus:ring-yellow-400 outline-none transition text-slate-800" placeholder="12345" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-slate-100 mt-2">
                            <button type="submit" id="btnSaveExam" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-500/30 transition active:scale-95 flex justify-center items-center gap-2">
                                <i class="fas fa-save"></i> Simpan Jadwal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
}

// Helper untuk menutup modal
function closeExamModal() {
    const modal = document.getElementById('examModal');
    if (modal) modal.classList.add('hidden');
}



    // --- HANDLE EXAM ACTIONS ---
    function handleExamSubmit(e) {
        e.preventDefault();
        const fd = new FormData(e.target);
        const data = Object.fromEntries(fd.entries());
        closeExamModal();
        document.getElementById('global-loading').classList.remove('hidden');

        if (data.examId) {
            // --- MODIFIKASI UPDATE: Kirim UserID & Token ---
            google.script.run.withSuccessHandler(res => {
                document.getElementById('global-loading').classList.add('hidden');
                if (res.success) { 
                    Swal.fire('Berhasil', 'Data diperbarui!', 'success'); 
                    refreshExamList(); 
                } else { 
                    Swal.fire('Gagal', res.message, 'error'); 
                }
            }).updateExam(data, currentUser.userID, currentUser.token);
        } else {
            // --- MODIFIKASI CREATE: Kirim UserID & Token ---
            google.script.run.withSuccessHandler(res => {
                document.getElementById('global-loading').classList.add('hidden');
                // Cek respon (Server sekarang mengembalikan object success/message utk create juga)
                if (res && res.success === false) {
                    Swal.fire('Gagal', res.message, 'error');
                } else {
                    Swal.fire('Berhasil', 'Jadwal dibuat!', 'success'); 
                    refreshExamList();
                }
            }).createExam(data, currentUser.userID, currentUser.token);
        }
    }

    function handleDeleteExam(examId) {
        Swal.fire({
            title: 'Hapus Ujian?', 
            text: "Data nilai terkait mungkin hilang.", 
            icon: 'warning',
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            cancelButtonColor: '#3085d6', 
            confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('global-loading').classList.remove('hidden');
                
                // --- MODIFIKASI: Kirim UserID & Token ---
                google.script.run.withSuccessHandler(res => {
                    document.getElementById('global-loading').classList.add('hidden');
                    if(res.success) { 
                        Swal.fire('Terhapus!', 'Data dihapus.', 'success'); 
                        refreshExamList(); 
                    } else { 
                        Swal.fire('Gagal', res.message, 'error'); 
                    }
                }).deleteExam(examId, currentUser.userID, currentUser.token);
            }
        });
    }

// Ubah nama fungsi agar sesuai dengan panggilan di HTML (onclick)
function toggleExamStatus(examId, currentStatus) {
  const sheet = SS.getSheetByName('Exams');
  const data = sheet.getDataRange().getValues();
  
  // Tentukan status baru (Kebalikan dari status sekarang)
  // Jika sekarang 'Aktif', maka baru 'Non-Aktif', dan sebaliknya.
  let newStatus = (currentStatus === 'Aktif') ? 'Non-Aktif' : 'Aktif';

  for (let i = 1; i < data.length; i++) {
    // Cek ID Ujian (Kolom A / Indeks 0)
    if (String(data[i][0]) === String(examId)) {
      const rowIdx = i + 1; // Baris di Spreadsheet (1-based)
      
      // 1. Update Status (Kolom G / Indeks 7)
      sheet.getRange(rowIdx, 7).setValue(newStatus);
      
      // 2. LOGIKA RESET WAKTU
      // Jika status berubah menjadi 'Non-Aktif', hapus waktu mulai & selesai
      if (newStatus === 'Non-Aktif') {
        sheet.getRange(rowIdx, 4).clearContent(); // Hapus Kolom D (Date/Start)
        sheet.getRange(rowIdx, 8).clearContent(); // Hapus Kolom H (EndDate)
      }
      
      return { 
        success: true, 
        newStatus: newStatus, 
        message: newStatus === 'Non-Aktif' 
          ? 'Status Non-Aktif. Waktu ujian telah direset.' 
          : 'Status Aktif.' 
      };
    }
  }
  return { success: false, message: 'Data tidak ditemukan.' };
}

// Fungsi dipanggil saat tombol status diklik
function switchStatus(id, currentStatus) {
    // Tampilkan loading kecil atau disable tombol agar tidak diklik ganda
    Swal.fire({
        title: 'Memproses...',
        text: 'Mengubah status ujian...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    google.script.run
      .withSuccessHandler(function(res) {
          if (res.success) {
              Swal.fire({
                  icon: 'success',
                  title: 'Berhasil',
                  text: res.message,
                  timer: 1500,
                  showConfirmButton: false
              });
              // Refresh tabel untuk melihat perubahan (Status berubah & Waktu kosong)
              loadExams(); 
          } else {
              Swal.fire('Gagal', res.message, 'error');
          }
      })
      .withFailureHandler(function(err) {
          Swal.fire('Error', err.message, 'error');
      })
      .toggleExamStatus(id, currentStatus); // Memanggil fungsi backend yang baru dibuat
}
    function refreshExamList() {
        // --- MODIFIKASI: Kirim UserID & Token ---
        google.script.run.withSuccessHandler(exams => {
            cachedExams = exams; 
            renderExamForm(document.getElementById('admin-content'));
        }).getExamList(currentUser.userID, currentUser.token);
    }

function refreshDashboard() {
    const content = document.getElementById('admin-content');
    // Tampilkan animasi loading
    content.innerHTML = '<div class="flex flex-col items-center justify-center h-full text-slate-400 fade-in"><i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> Memuat ulang data dashboard...</div>';
    
    // --- MODIFIKASI: Kirim UserID & Token ---
    google.script.run.withSuccessHandler(exams => {
        cachedExams = exams; 
        renderAdminHome(content); 
    }).getExamList(currentUser.userID, currentUser.token);
}

    // --- BANK SOAL & IMPORT FIX ---
function renderQuestionBank(container) {
    // Siapkan opsi dropdown dari data ujian yang ada
    let examOptions = cachedExams.map(e => `<option value="${e.id}">${e.subject} (${e.class})</option>`).join('');
    
    // --- LOAD DATA GAMBAR DI BACKGROUND AGAR AUTOCOMPLETE SIAP ---
    if(allImagesData.length === 0) {
        google.script.run.withSuccessHandler(imgs => { allImagesData = imgs || []; }).getSavedImages();
    }

    container.innerHTML = `
    <div class="fade-in w-full space-y-4">
       
       <div class="dash-card p-6">
           <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
               <div>
                   <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                       <i class="fas fa-book-open text-blue-600"></i> Bank Soal
                   </h2>
                   <p class="text-sm text-slate-500 mt-1">Kelola pertanyaan, kunci jawaban, dan import soal.</p>
               </div>
               
               <div class="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                   <button onclick="resetQuestionForm(); document.getElementById('form-add-q').classList.remove('hidden'); document.getElementById('form-import-q').classList.add('hidden'); document.getElementById('form-import-excel').classList.add('hidden');"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                       <i class="fas fa-plus"></i> <span class="hidden sm:inline">Manual</span>
                   </button>
                   
                   <button onclick="document.getElementById('form-import-q').classList.remove('hidden'); document.getElementById('form-add-q').classList.add('hidden'); document.getElementById('form-import-excel').classList.add('hidden');"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                       <i class="fab fa-google"></i> <span class="hidden sm:inline">G-Form</span>
                   </button>

                   <button onclick="document.getElementById('form-import-excel').classList.remove('hidden'); document.getElementById('form-add-q').classList.add('hidden'); document.getElementById('form-import-q').classList.add('hidden');"
                    class="bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 transform active:scale-95">
                       <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Excel</span>
                   </button>
               </div>
           </div>

           <div class="relative w-full">
               <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Pilih Mata Pelajaran Untuk Diedit</label>
               <div class="relative group">
                   <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                       <i class="fas fa-search text-slate-400 group-focus-within:text-blue-500 transition"></i>
                   </div>
                   <select id="select-exam-q" class="pl-10 pr-4 py-3 w-full border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm bg-slate-50 focus:bg-white text-slate-700 appearance-none cursor-pointer font-medium" onchange="loadQuestionsTable(this.value)">
                       <option value="">-- Silakan Pilih Mata Pelajaran --</option>${examOptions}
                   </select>
                   <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                       <i class="fas fa-chevron-down text-xs"></i>
                   </div>
               </div>
           </div>
       </div>

       <div id="form-import-q" class="hidden dash-card p-6 bg-emerald-50 border-emerald-100 fade-in">
           <div class="flex items-center justify-between mb-4 border-b border-emerald-200 pb-3">
               <div class="flex items-center gap-3 text-emerald-800">
                   <div class="w-10 h-10 rounded-lg bg-emerald-200 flex items-center justify-center text-emerald-700 shadow-sm"><i class="fab fa-google text-lg"></i></div>
                   <h3 class="font-bold text-lg">Import dari Google Form</h3>
               </div>
               <button onclick="document.getElementById('form-import-q').classList.add('hidden')" class="text-emerald-600 hover:bg-emerald-100 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
           </div>
           
           <div class="bg-white/60 p-4 rounded-xl border border-emerald-100 mb-4 text-sm text-emerald-700 flex items-start gap-3">
              <i class="fas fa-info-circle mt-0.5 text-lg"></i>
              <div>
                  <p class="font-bold">Panduan Import:</p>
                  <ul class="list-disc list-inside mt-1 space-y-1 text-xs">
                      <li>Pastikan Anda adalah <b>Pemilik (Owner)</b> formulir.</li>
                      <li>Salin link dari address bar saat membuka mode edit (akhiran <b>/edit</b>).</li>
                      <li>Fitur ini mendukung: Pilihan Ganda & Isian Singkat.</li>
                  </ul>
              </div>
           </div>
           
           <div class="flex flex-col md:flex-row gap-4">
              <div class="relative flex-1 group">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-emerald-500"><i class="fas fa-link"></i></div>
                  <input type="text" id="input-form-url" placeholder="Tempel Link Google Form di sini..." class="pl-10 w-full border border-emerald-200 p-3 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white transition shadow-sm">
              </div>
              <button onclick="triggerImport()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-emerald-700 transition shadow-lg flex items-center justify-center gap-2 transform active:scale-95 whitespace-nowrap">
                  <i class="fas fa-file-import"></i> Mulai Import
              </button>
           </div>
       </div>

       <div id="form-import-excel" class="hidden dash-card p-6 bg-green-50 border-green-200 fade-in">
           <div class="flex items-center justify-between mb-4 border-b border-green-200 pb-3">
               <div class="flex items-center gap-3 text-green-800">
                   <div class="w-10 h-10 rounded-lg bg-green-200 flex items-center justify-center text-green-700 shadow-sm"><i class="fas fa-file-excel text-lg"></i></div>
                   <h3 class="font-bold text-lg">Import Soal dari Excel</h3>
               </div>
               <button onclick="document.getElementById('form-import-excel').classList.add('hidden')" class="text-green-600 hover:bg-green-100 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
           </div>
           
           <div class="flex flex-col md:flex-row gap-6">
               <div class="flex-1 space-y-4">
                   <div class="bg-white p-4 rounded-xl border border-green-200 text-sm text-slate-600">
                       <p class="font-bold text-green-700 mb-2"><i class="fas fa-info-circle"></i> Aturan Format Excel:</p>
                       <ul class="list-disc list-inside space-y-1 text-xs">
                           <li>Baris pertama harus <b>Header</b>. Data dimulai baris ke-2.</li>
                           <li>Kolom A: <b>Tipe</b> (PG / BS / Esai).</li>
                           <li>Kolom B: <b>Pertanyaan</b>.</li>
                           <li>Kolom C s/d G: <b>Pilihan A - E</b> (Untuk PG).</li>
                           <li>Kolom H: <b>Kunci Jawaban</b> (Teks opsi).</li>
                           <li>Kolom I: <b>Wajib</b> (TRUE/FALSE).</li>
                       </ul>
                       <button onclick="downloadTemplateExcel()" class="mt-3 text-xs font-bold text-blue-600 hover:underline"><i class="fas fa-download"></i> Download Template Excel</button>
                   </div>
               </div>

               <div class="flex-1 flex flex-col justify-center">
                   <label class="block mb-2 text-sm font-bold text-slate-600">Upload File (.xlsx)</label>
                   <input type="file" id="input-excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500
                      file:mr-4 file:py-2.5 file:px-4
                      file:rounded-full file:border-0
                      file:text-sm file:font-semibold
                      file:bg-green-100 file:text-green-700
                      hover:file:bg-green-200
                      cursor-pointer border border-green-200 rounded-xl bg-white p-2
                    "/>
                   <button onclick="processExcelImport()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                       <i class="fas fa-upload"></i> Proses Import
                   </button>
               </div>
           </div>
       </div>

       <div id="form-add-q" class="hidden dash-card p-6 border-blue-100 relative overflow-visible fade-in">
          <div class="flex items-center justify-between mb-6 border-b border-slate-100 pb-4">
             <div class="flex items-center gap-3">
                 <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center text-blue-600 shadow-sm"><i class="fas fa-pen-fancy"></i></div>
                 <h3 class="font-bold text-lg text-slate-800">Editor Soal Manual</h3>
             </div>
             <button onclick="resetQuestionForm(); document.getElementById('form-add-q').classList.add('hidden')" class="text-slate-400 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition text-sm font-bold flex items-center gap-1"><i class="fas fa-times"></i> Tutup</button>
          </div>
          
          <form onsubmit="handleAddQuestion(event)" class="space-y-5">
             <input type="hidden" name="examId" id="input-exam-id">
             <input type="hidden" name="questionId" id="input-question-id">

             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
               <div>
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipe Soal</label>
                   <select name="type" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition cursor-pointer" onchange="toggleOptionsInput(this.value)">
                      <option value="PG">Pilihan Ganda</option>
                      <option value="BS">Benar/Salah</option>
                      <option value="JODOH">Menjodohkan</option>
                      <option value="Esai">Esai</option>
                   </select>
               </div>
               <div>
                   <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Status Wajib</label>
                   <select name="isRequired" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition font-medium text-slate-700 cursor-pointer">
                      <option value="TRUE">Wajib Diisi</option>
                      <option value="FALSE">Opsional</option>
                   </select>
               </div>
               
              <div class="relative group">
                  <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Media Gambar & Ukuran</label>
                  <div class="flex gap-2">
                      <div class="relative flex-1">
                          <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none"><i class="far fa-image"></i></span>
                          <input type="text" name="image" id="input-image-ac" 
                                placeholder="Ketik nama file..." 
                                class="w-full border border-slate-200 p-3 pl-10 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition"
                                autocomplete="off"
                                onkeyup="handleImageAutocomplete(this)"
                                onfocus="handleImageAutocomplete(this)"
                                onblur="setTimeout(() => document.getElementById('ac-results').classList.add('hidden'), 200)">
                          
                          <div id="ac-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                      </div>

                      <div class="w-1/3">
                          <select id="input-image-size" class="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-blue-500 transition font-medium text-slate-700 cursor-pointer">
                              <option value="w300">Kecil</option>
                              <option value="w600">Sedang</option>
                              <option value="w1000" selected>Besar</option>
                          </select>
                      </div>
                  </div>
              </div>
             </div>

             <div>
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pertanyaan</label>
                 <textarea name="content" placeholder="Tulis teks pertanyaan di sini..." class="w-full border border-slate-200 p-4 rounded-xl bg-slate-50 focus:bg-white h-32 focus:ring-2 focus:ring-blue-500 outline-none transition resize-y" required></textarea>
             </div>
             
             <div id="options-area" class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                <p class="text-xs font-bold text-slate-500 mb-3 flex items-center gap-2"><i class="fas fa-list-ul"></i> PILIHAN JAWABAN (A-E)</p>
                <div class="space-y-3">
                    <div class="flex items-center gap-3"><span class="font-bold text-slate-400 w-6 text-center bg-white border rounded py-1">A</span> <input type="text" id="opt-0" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pilihan A"></div>
                    <div class="flex items-center gap-3"><span class="font-bold text-slate-400 w-6 text-center bg-white border rounded py-1">B</span> <input type="text" id="opt-1" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pilihan B"></div>
                    <div class="flex items-center gap-3"><span class="font-bold text-slate-400 w-6 text-center bg-white border rounded py-1">C</span> <input type="text" id="opt-2" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pilihan C"></div>
                    <div class="flex items-center gap-3"><span class="font-bold text-slate-400 w-6 text-center bg-white border rounded py-1">D</span> <input type="text" id="opt-3" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pilihan D"></div>
                    <div class="flex items-center gap-3"><span class="font-bold text-slate-400 w-6 text-center bg-white border rounded py-1">E</span> <input type="text" id="opt-4" class="flex-1 border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pilihan E"></div>
                </div>
             </div>

             <div id="pairs-area" class="hidden bg-slate-50 p-5 rounded-xl border border-slate-200">
                 <div class="flex justify-between items-center mb-3">
                   <p class="text-xs font-bold text-slate-500"><i class="fas fa-random"></i> PASANGAN (KIRI - KANAN)</p>
                   <button type="button" onclick="addPairInput()" class="text-blue-600 text-xs font-bold hover:underline bg-blue-50 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100 transition">+ Tambah Baris</button>
                </div>
                <div id="pairs-container" class="space-y-2">
                   <div class="grid grid-cols-2 gap-3">
                       <input type="text" class="pair-left border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pertanyaan (Kiri)">
                       <input type="text" class="pair-right border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Jawaban (Kanan)">
                   </div>
                </div>
             </div>
             
             <div>
                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kunci Jawaban</label>
                 <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-green-600"><i class="fas fa-key"></i></div>
                    <input type="text" name="correct" id="correct-input" placeholder="Contoh: Pilihan A (Harus sama persis dengan teks opsi)" class="pl-10 w-full border border-green-200 p-3 rounded-xl font-medium bg-green-50 text-green-800 focus:ring-2 focus:ring-green-500 outline-none transition placeholder-green-700/50">
                 </div>
                 <p class="text-[10px] text-slate-400 mt-1 ml-1">*Untuk tipe Benar/Salah, isi 'Benar' atau 'Salah'.</p>
             </div>
             
             <button type="submit" class="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 transform active:scale-95">
                 <i class="fas fa-save"></i> Simpan Pertanyaan
             </button>
          </form>
       </div>

       <div id="q-table-container" class="w-full mt-6 transition-all duration-300">
           <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
               <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                   <i class="fas fa-mouse-pointer text-3xl text-slate-300"></i>
               </div>
               <h3 class="text-lg font-bold text-slate-600">Belum Ada Ujian Dipilih</h3>
               <p class="text-sm text-slate-400 mt-1 max-w-xs mx-auto">Silakan pilih mata pelajaran pada dropdown di atas untuk mulai mengelola atau mengimpor soal.</p>
           </div>
       </div>
    </div>
    `;
}

/* ==========================================
   LOGIKA AUTOCOMPLETE GAMBAR
   ========================================== */

function handleImageAutocomplete(input) {
    const term = input.value.toLowerCase().trim();
    const resultDiv = document.getElementById('ac-results');
    
    // Pastikan data gambar sudah ada
    if (!allImagesData || allImagesData.length === 0) {
        google.script.run.withSuccessHandler(imgs => { allImagesData = imgs || []; }).getSavedImages();
        return;
    }

    if (!term) {
        resultDiv.classList.add('hidden');
        return;
    }

    // Filter gambar berdasarkan nama
    const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));
    
    if (matches.length === 0) {
        resultDiv.innerHTML = `<div class="p-3 text-xs text-slate-400 italic text-center">Tidak ada gambar ditemukan</div>`;
        resultDiv.classList.remove('hidden');
        return;
    }

    // Render Hasil Pencarian dengan Preview Kecil
    resultDiv.innerHTML = matches.map(img => `
        <div onclick="selectImageSuggestion('${img.link}')" class="flex items-center gap-3 p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 transition">
            <img src="${img.link}" class="w-10 h-10 rounded bg-slate-100 object-cover border border-slate-200 shrink-0">
            <div class="overflow-hidden">
                <p class="text-xs font-bold text-slate-700 truncate">${img.name}</p>
                <p class="text-[10px] text-slate-400 truncate font-mono">...${img.link.slice(-15)}</p>
            </div>
        </div>
    `).join('');

    resultDiv.classList.remove('hidden');
}

function selectImageSuggestion(link) {
    const input = document.getElementById('input-image-ac');
    input.value = link; // Isi input dengan Link Gambar
    document.getElementById('ac-results').classList.add('hidden'); // Tutup dropdown
    
    // Beri efek visual sukses
    input.classList.add('ring-2', 'ring-green-500', 'bg-green-50');
    setTimeout(() => input.classList.remove('ring-2', 'ring-green-500', 'bg-green-50'), 1000);
}

    function toggleOptionsInput(type) {
        document.getElementById('options-area').classList.toggle('hidden', type !== 'PG');
        document.getElementById('pairs-area').classList.toggle('hidden', type !== 'JODOH');
        const keyInput = document.getElementById('correct-input');
        if(type === 'JODOH') { keyInput.value = 'Auto-Check'; keyInput.readOnly = true; } 
        else { keyInput.readOnly = false; if(keyInput.value==='Auto-Check') keyInput.value=''; }
    }

    function addPairInput() {
        const div = document.createElement('div');
        div.className = 'grid grid-cols-2 gap-2';
        div.innerHTML = `<input type="text" class="pair-left border p-2 rounded" placeholder="Kiri"><input type="text" class="pair-right border p-2 rounded" placeholder="Kanan">`;
        document.getElementById('pairs-container').appendChild(div);
    }

function loadQuestionsTable(examId) {
   if(!examId) return;
   
   // 1. Reset Form Input
   if (typeof resetQuestionForm === "function") resetQuestionForm();
   // 2. Set ID Ujian ke Hidden Input
   document.getElementById('input-exam-id').value = examId;
   // 3. Ambil Container
   const container = document.getElementById('q-table-container');
   container.className = 'w-full mt-6 transition-all duration-300';
   // Tampilan Loading
   container.innerHTML = `
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 flex flex-col items-center justify-center animate-pulse w-full">
          <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
          <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
      </div>`;
      
   // 4. Ambil Data dari Server
   // --- MODIFIKASI: Kirim UserID & Token ---
   google.script.run.withSuccessHandler(qs => {
      // SIMPAN DATA KE VARIABLE GLOBAL
      allQuestionsData = qs || [];
      filteredQuestions = qs || []; 
      currentQPage = 1;

      // JIKA DATA KOSONG (Belum ada soal)
      if(qs.length === 0) { 
          container.innerHTML = `
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100 shadow-sm">
                    <i class="fas fa-folder-open text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-slate-700 font-bold text-lg">Belum Ada Soal</h3>
                <p class="text-slate-400 text-sm mt-1 max-w-xs mx-auto">Data soal kosong. Silakan tambah manual atau import.</p>
                <button onclick="document.getElementById('form-add-q').classList.remove('hidden'); document.getElementById('form-add-q').scrollIntoView({behavior: 'smooth'})" class="mt-6 text-blue-600 font-bold text-sm hover:underline">
                    + Tambah Soal Pertama
                </button>
            </div>`;
          return; 
      }
      
      // JIKA ADA DATA: Render Kerangka Tabel + Kontrol Navigasi
      container.innerHTML = `
        <div class="space-y-4 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                
                <div class="flex items-center gap-2 text-sm text-slate-600">
                    <span>Show</span>
                    <select onchange="changeQRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-slate-50">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="500">500</option>
                        <option value="all">All</option>
                    </select>
                    <span>entries</span>
                </div>

                <div class="relative w-full md:w-64">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-search"></i></span>
                    <input type="text" id="question-search-input" onkeyup="handleQuestionSearch(this.value)" placeholder="Cari soal..." class="pl-9 w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                </div>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden w-full">
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm">
                                <th class="py-4 px-2 text-center w-16">#</th>
                                <th class="py-4 px-5">Pertanyaan & Metadata</th>
                                <th class="py-4 px-5 w-1/4">Kunci Jawaban</th>
                                <th class="py-4 px-5 text-right w-24">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="q-table-body" class="divide-y divide-slate-100 bg-white">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="q-pagination-controls" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
                <div class="text-slate-500" id="q-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                <div class="flex gap-2">
                    <button onclick="changeQPage('prev')" id="btn-q-prev" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Sebelumnya</button>
                    <button onclick="changeQPage('next')" id="btn-q-next" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Selanjutnya</button>
                </div>
            </div>
        </div>`;
      
      // Panggil Render Internal
      renderQuestionsInternal(examId);

   }).getQuestionsByExam(examId, currentUser.userID, currentUser.token);
}

function renderQuestionsInternal(examId) {
    const tbody = document.getElementById('q-table-body');
    const infoDisplay = document.getElementById('q-pagination-info');
    const btnPrev = document.getElementById('btn-q-prev');
    const btnNext = document.getElementById('btn-q-next');
    
    // Cek Data Filter Kosong
    if (filteredQuestions.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400">Data tidak ditemukan.</td></tr>`;
        infoDisplay.innerText = 'Menampilkan 0 data';
        btnPrev.disabled = true;
        btnNext.disabled = true;
        return;
    }

    // Hitung Pagination
    const totalData = filteredQuestions.length;
    const maxPage = Math.ceil(totalData / qRowsPerPage);
    
    if (currentQPage > maxPage) currentQPage = maxPage;
    if (currentQPage < 1) currentQPage = 1;

    const startIndex = (currentQPage - 1) * qRowsPerPage;
    const endIndex = Math.min(startIndex + qRowsPerPage, totalData);
    
    const pageData = filteredQuestions.slice(startIndex, endIndex);

    // Generate HTML Baris
    const rowsHtml = pageData.map((q, i) => {
        // Hitung nomor urut asli
        const realIndex = startIndex + i + 1;

        // Styling Badge & Icon
        let typeBadgeClass = 'bg-slate-100 text-slate-600 border-slate-200';
        let typeIcon = 'fa-question';
        
        if (q.type === 'PG') { typeBadgeClass = 'bg-blue-50 text-blue-700 border-blue-200'; typeIcon = 'fa-list-ul'; }
        else if (q.type === 'Esai') { typeBadgeClass = 'bg-purple-50 text-purple-700 border-purple-200'; typeIcon = 'fa-paragraph'; }
        else if (q.type === 'BS') { typeBadgeClass = 'bg-orange-50 text-orange-700 border-orange-200'; typeIcon = 'fa-check-square'; }
        else if (q.type === 'JODOH') { typeBadgeClass = 'bg-teal-50 text-teal-700 border-teal-200'; typeIcon = 'fa-random'; }

        const isReq = (String(q.isRequired) === 'TRUE');
        const hasImg = (q.image && q.image.length > 5);
        const qStr = encodeURIComponent(JSON.stringify(q));

        return `
        <tr class="group border-b border-slate-50 last:border-0 hover:bg-slate-50 transition-colors duration-200">
            <td class="p-5 align-top text-center text-slate-400 font-medium text-sm w-16">${realIndex}</td>
            <td class="p-5 align-top">
                <div class="flex gap-4">
                    <div class="flex-shrink-0 mt-0.5">
                        <span class="w-10 h-10 rounded-lg flex flex-col items-center justify-center text-[10px] font-bold border ${typeBadgeClass} shadow-sm">
                            <i class="fas ${typeIcon} text-xs mb-0.5"></i>${q.type.substring(0,3)}
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-slate-700 font-medium text-sm leading-relaxed line-clamp-2 group-hover:line-clamp-none transition-all duration-300 cursor-pointer" title="${q.content}">${q.content}</p>
                        <div class="flex items-center gap-2 mt-2">
                             ${isReq ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-red-50 text-red-600 border border-red-100 uppercase tracking-wide">Wajib</span>` : ''}
                             ${hasImg ? `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 uppercase tracking-wide"><i class="far fa-image"></i> Gambar</span>` : ''}
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-5 align-top w-1/4">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Kunci</div>
                <div class="font-mono text-sm font-medium text-emerald-700 bg-emerald-50 px-3 py-2 rounded border border-emerald-100 break-words max-h-20 overflow-y-auto custom-scrollbar">
                    ${q.key || '-'}
                </div>
            </td>
            <td class="p-5 align-top w-24 text-right">
                <div class="flex flex-col gap-2 items-end opacity-60 group-hover:opacity-100 transition-opacity">
                    <button onclick="editQuestion('${qStr}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-blue-600 hover:bg-blue-50 border border-transparent hover:border-blue-100 transition-all"><i class="fas fa-pencil-alt text-sm"></i></button>
                    <button onclick="deleteQuestion('${q.id}','${document.getElementById('input-exam-id').value}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 transition-all"><i class="fas fa-trash-alt text-sm"></i></button>
                </div>
            </td>
        </tr>`;
    }).join('');

    // Inject ke Body
    tbody.innerHTML = rowsHtml;

    // Update Info & Buttons
    infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;
    
    btnPrev.disabled = (currentQPage === 1);
    if(currentQPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
    else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');

    btnNext.disabled = (currentQPage === maxPage || maxPage === 0);
    if(currentQPage === maxPage || maxPage === 0) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
    else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
}

function handleAddQuestion(e) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    const qId = document.getElementById('input-question-id').value; // Cek ID

    // --- LOGIKA BARU: PROSES UKURAN GAMBAR ---
    // Ambil nilai dari dropdown ukuran
    const sizeSelect = document.getElementById('input-image-size');
    const size = sizeSelect ? sizeSelect.value : 'w1000'; 
    
    // Jika ada link gambar dari Google Drive Thumbnail, atur parameternya
    if (data.image && data.image.includes('drive.google.com/thumbnail')) {
        // Hapus parameter sz lama jika ada, lalu tambahkan yang baru sesuai pilihan dropdown
        let cleanUrl = data.image.replace(/&sz=[^&]+/, ''); 
        data.image = cleanUrl + `&sz=${size}`;
    }
    // -----------------------------------------

    // --- PROSES DATA OPTIONS ---
    if(data.type === 'PG') {
        let opts = [];
        for(let i=0; i<5; i++) { 
            let v = document.getElementById('opt-'+i).value; 
            if(v) opts.push(v);
        } 
        data.options = opts;
    } else if(data.type === 'BS') { 
        data.options = ['Benar', 'Salah'];
    } else if(data.type === 'JODOH') {
        let pairs = [];
        const lefts = document.querySelectorAll('.pair-left'); 
        const rights = document.querySelectorAll('.pair-right');
        lefts.forEach((el, i) => { 
            if(el.value && rights[i].value) {
                pairs.push({q: el.value, a: rights[i].value}); 
            }
        });
        data.options = pairs;
    } else {
        data.options = [];
    }

    // --- LOGIKA CABANG (ADD atau UPDATE) ---
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.disabled = true; 
    btn.innerText = 'Menyimpan...';

    if (qId) {
        // --- MODE UPDATE ---
        data.questionId = qId;
        google.script.run.withSuccessHandler(res => {
            btn.disabled = false; btn.innerHTML = originalText;
            if(res.success) {
                Swal.fire('Berhasil', 'Soal berhasil diupdate!', 'success');
                resetQuestionForm(); // Reset form kembali ke mode Add
                loadQuestionsTable(data.examId);
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }).updateQuestion(data);
    } else {
        // --- MODE ADD BARU ---
        google.script.run.withSuccessHandler(() => { 
            btn.disabled = false; btn.innerHTML = originalText;
            Swal.fire('Tersimpan!','Soal berhasil ditambahkan','success'); 
            // Kita reset manual formnya tapi tetap pertahankan ID Ujian
            const currentExamId = document.getElementById('input-exam-id').value;
            resetQuestionForm(); 
            document.getElementById('input-exam-id').value = currentExamId;
            
            loadQuestionsTable(data.examId); 
        }).addQuestion(data);
    }
}

/* ==========================================
   AUTOCOMPLETE LOGO KONFIGURASI
   ========================================== */

// 1. Fungsi Pencarian saat mengetik
function handleConfigLogoSearch(input) {
    const term = input.value.toLowerCase();
    const resultDiv = document.getElementById('cfg-logo-results');
    
    // Pastikan data gambar sudah dimuat
    // (Jika user langsung ke menu Config tanpa buka Bank Soal/Gambar dulu, data mungkin kosong)
    if (typeof allImagesData === 'undefined' || allImagesData.length === 0) {
        // Coba load data gambar di background jika kosong
        google.script.run.withSuccessHandler(data => {
            allImagesData = data; // Simpan ke variabel global
            // Panggil ulang fungsi search setelah data dapat
            if(input.value.length > 0) handleConfigLogoSearch(input); 
        }).getAllImages(); 
        
        // Tampilkan loading sementara
        resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400">Memuat data gambar...</div>';
        resultDiv.classList.remove('hidden');
        return;
    }

    // Jika input kosong, sembunyikan dropdown
    if (term.length < 1) {
        resultDiv.classList.add('hidden');
        return;
    }

    // Filter Data
    const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));

    // Render Hasil Dropdown
    if (matches.length > 0) {
        resultDiv.innerHTML = matches.map(img => `
            <div class="flex items-center gap-3 p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-50 transition"
                 onclick="selectConfigLogo('${img.link}')">
                <img src="${img.link}" referrerpolicy="no-referrer" class="w-8 h-8 rounded bg-slate-200 object-cover">
                <div class="overflow-hidden">
                    <div class="text-xs font-bold text-slate-700 truncate">${img.name}</div>
                    <div class="text-[10px] text-slate-400 truncate">${img.id}</div>
                </div>
            </div>
        `).join('');
        resultDiv.classList.remove('hidden');
    } else {
        resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400 text-center">Tidak ada gambar ditemukan</div>';
        resultDiv.classList.remove('hidden');
    }
}

// 2. Fungsi saat Gambar Dipilih
function selectConfigLogo(link) {
    // Isi Input dengan Link
    const input = document.getElementById('cfg-app-logo');
    input.value = link;
    
    // Sembunyikan Dropdown
    document.getElementById('cfg-logo-results').classList.add('hidden');
    
    // Update Preview Gambar Samping
    updateLogoPreview(link);
}


/* ==========================================
   AUTOCOMPLETE BACKGROUND KONFIGURASI
   ========================================== */

// 1. Fungsi Pencarian (Mirip Logo tapi target ID beda)
function handleConfigBgSearch(input) {
    const term = input.value.toLowerCase();
    const resultDiv = document.getElementById('cfg-bg-results');
    
    // Load data jika belum ada
    if (typeof allImagesData === 'undefined' || allImagesData.length === 0) {
        google.script.run.withSuccessHandler(data => {
            allImagesData = data;
            if(input.value.length > 0) handleConfigBgSearch(input); 
        }).getAllImages(); 
        resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400">Memuat data...</div>';
        resultDiv.classList.remove('hidden');
        return;
    }

    if (term.length < 1) {
        resultDiv.classList.add('hidden');
        return;
    }

    const matches = allImagesData.filter(img => img.name.toLowerCase().includes(term));

    if (matches.length > 0) {
        resultDiv.innerHTML = matches.map(img => `
            <div class="flex items-center gap-3 p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-50 transition"
                 onclick="selectConfigBg('${img.link}')">
                <img src="${img.link}" referrerpolicy="no-referrer" class="w-12 h-8 rounded bg-slate-200 object-cover">
                <div class="overflow-hidden">
                    <div class="text-xs font-bold text-slate-700 truncate">${img.name}</div>
                </div>
            </div>
        `).join('');
        resultDiv.classList.remove('hidden');
    } else {
        resultDiv.innerHTML = '<div class="p-3 text-xs text-slate-400 text-center">Tidak ditemukan</div>';
        resultDiv.classList.remove('hidden');
    }
}

// 2. Saat Background Dipilih
function selectConfigBg(link) {
    document.getElementById('cfg-app-bg').value = link;
    document.getElementById('cfg-bg-results').classList.add('hidden');
    updateBgPreview(link);
}

// 3. Update Preview Box Kecil
function updateBgPreview(url) {
    const img = document.getElementById('cfg-bg-preview');
    img.style.display = 'block';
    img.src = url;
}
    // --- FUNGSI TRIGGER IMPORT (FIXED) ---
    function triggerImport() {
       const examId = document.getElementById('select-exam-q').value;
       const urlInput = document.getElementById('input-form-url');
       const url = urlInput.value.trim();
       
       if(!examId) { Swal.fire('Peringatan', 'Silakan pilih Ujian (Mata Pelajaran) terlebih dahulu di dropdown atas!', 'warning'); return; }
       if(!url) { Swal.fire('Peringatan', 'Link Google Form tidak boleh kosong!', 'warning'); return; }

       const btn = document.querySelector('button[onclick="triggerImport()"]');
       const originalText = btn.innerHTML;
       btn.disabled = true;
       btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

       google.script.run
         .withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            if(res.success) {
                Swal.fire('Berhasil!', `Sukses mengimport ${res.count} soal!`, 'success');
                urlInput.value = ''; 
                loadQuestionsTable(examId); 
                document.getElementById('form-import-q').classList.add('hidden'); 
            } else {
                Swal.fire('Gagal Import', res.message, 'error');
            }
         })
         .withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            Swal.fire('Error Sistem', err.message, 'error');
         })
         .importQuestionsFromForm(examId, url);
    }

    function deleteQuestion(qid, eid) {
       Swal.fire({title:'Hapus Soal?',text:'Tidak bisa dikembalikan.',icon:'question',showCancelButton:true,confirmButtonColor:'#d33'}).then(r => {
           if(r.isConfirmed) google.script.run.withSuccessHandler(()=>loadQuestionsTable(eid)).deleteQuestion(qid);
       });
    }

function renderResults(container) {
    // Menyiapkan opsi dropdown dari data ujian yang ada
    let opts = cachedExams.map(e => `<option value="${e.id}">${e.subject} (${e.class})</option>`).join('');
    
    container.innerHTML = `
      <div class="fade-in w-full space-y-6"> 
          
          <div class="dash-card p-6">
              <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                  <div>
                     <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                          <i class="fas fa-poll-h text-blue-600"></i> Laporan Hasil & Penilaian
                     </h3>
                     <p class="text-sm text-slate-500 mt-1">Pilih ujian untuk melihat daftar nilai siswa.</p>
                  </div>

                  <button id="btn-pdf-recap" onclick="downloadResultPDF()" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-red-500/30 transition flex items-center gap-2 transform active:scale-95">
                      <i class="fas fa-file-pdf"></i> <span class="hidden sm:inline">Download Rekap PDF</span>
                  </button>
              </div>
 
              <div class="w-full">
                 <div class="relative group">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                         <i class="fas fa-filter"></i>
                     </div>
                     <select id="select-result-exam" class="pl-10 pr-4 py-3 border border-slate-200 rounded-xl w-full bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 shadow-sm transition-all appearance-none font-medium cursor-pointer" onchange="loadResultsTable(this.value)">
                         <option value="">-- Pilih Mata Pelajaran --</option>${opts}
                     </select>
                     <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-slate-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                 </div>
              </div>
          </div>
          
          <div id="res-table-wrapper" class="hidden w-full transition-all duration-300 space-y-4">
             
             <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                 
                 <div class="flex items-center gap-2 text-sm text-slate-600">
                     <span>Tampilkan</span>
                     <select onchange="changeRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-slate-50">
                         <option value="10">10</option>
                         <option value="25">25</option>
                         <option value="50">50</option>
                         <option value="100">100</option>
                         <option value="500">500</option>
                         <option value="all">Semua</option>
                     </select>
                     <span>data</span>
                 </div>
 
                 <div class="relative w-full md:w-64">
                     <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400"><i class="fas fa-search"></i></span>
                     <input type="text" id="result-search-input" onkeyup="handleResultSearch(this.value)" placeholder="Cari Nama / ID..." class="pl-9 w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                 </div>
             </div>
 
             <div id="res-table-container">
                 </div>
 
             <div id="pagination-controls" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 text-sm">
                 <div class="text-slate-500" id="pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                 <div class="flex gap-2">
                     <button onclick="changePage('prev')" id="btn-page-prev" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Sebelumnya</button>
                     <button onclick="changePage('next')" id="btn-page-next" class="px-3 py-1.5 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-medium">Selanjutnya</button>
                 </div>
             </div>
 
          </div>
 
          <div id="res-empty-state" class="w-full">
             <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
                 <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                     <i class="fas fa-chart-bar text-3xl text-slate-300"></i>
                 </div>
                 <h3 class="text-slate-600 font-bold">Menunggu Data</h3>
                 <p class="text-slate-400 text-sm mt-1">Silakan pilih mata pelajaran di atas.</p>
             </div>
          </div>
      </div>
    `;
}

function loadResultsTable(eid) {
    const wrapper = document.getElementById('res-table-wrapper');
    const emptyState = document.getElementById('res-empty-state');
    const container = document.getElementById('res-table-container');
    const btnPdf = document.getElementById('btn-pdf-recap');
 
    // Jika dropdown dipilih ke "Pilih Mata Pelajaran" (kosong)
    if(!eid) {
        wrapper.classList.add('hidden');
        emptyState.classList.remove('hidden');
        if(btnPdf) btnPdf.classList.add('hidden');
        return;
    }
 
    // Tampilkan Wrapper & Tombol PDF
    wrapper.classList.remove('hidden');
    emptyState.classList.add('hidden');
    if(btnPdf) btnPdf.classList.remove('hidden');
    
    // Tampilkan Loading State Manual
    container.innerHTML = `
       <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 flex flex-col items-center justify-center animate-pulse w-full">
           <div class="w-12 h-12 bg-slate-200 rounded-full mb-3"></div>
           <div class="h-4 bg-slate-200 rounded w-48 mb-2"></div>
       </div>`;

    // Ambil Data dari Server
    // --- MODIFIKASI: Kirim UserID & Token ---
    google.script.run.withSuccessHandler(res => {
       // SIMPAN DATA KE MEMORI BROWSER
       allResultsData = res || [];
       filteredResults = res || []; // Awalnya hasil filter = semua data
       currentPage = 1;             // Reset ke halaman 1
       
       // Reset Input Pencarian jika ada
       const searchInput = document.getElementById('result-search-input');
       if(searchInput) searchInput.value = '';
 
       // Panggil fungsi render internal untuk menampilkan data
       renderInternalTable();
 
    }).getExamResults(eid, currentUser.userID, currentUser.token);
}

function downloadResultPDF() {
    // 1. Ambil ID Ujian yang sedang dipilih
    const examId = document.getElementById('select-result-exam').value;

    if (!examId) {
        Swal.fire('Peringatan', 'Silakan pilih Mata Pelajaran terlebih dahulu.', 'warning');
        return;
    }

    // 2. Tampilkan Loading pada Tombol
    const btn = document.getElementById('btn-pdf-recap');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

    // 3. Panggil Server
    google.script.run
        .withSuccessHandler(res => {
            // Reset Tombol
            btn.disabled = false;
            btn.innerHTML = originalText;

            if (res.success) {
                // Buka Link PDF di Tab Baru
                window.open(res.url, '_blank');
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        })
        .withFailureHandler(err => {
            btn.disabled = false;
            btn.innerHTML = originalText;
            Swal.fire('Error', err.message, 'error');
        })
        .generateExamRecapPDF(examId, currentUser.userID, currentUser.token);
}

/* ==========================================
   LOGIKA LIHAT DETAIL JAWABAN (VIEWER)
   ========================================== */

function viewStudentAnswers(responseId) {
    // 1. Pastikan Modal Ada
    if (!document.getElementById('modal-view-answers')) {
        createViewAnswersModal();
    }

    const modal = document.getElementById('modal-view-answers');
    const content = document.getElementById('view-answers-content');
    const title = document.getElementById('view-answers-title');
    
    // 2. Tampilkan Modal & Loading
    modal.classList.remove('hidden');
    title.innerText = "Memuat Data...";
    content.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
           <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-teal-500"></i>
           <p>Mengambil lembar jawaban siswa...</p>
        </div>`;

    // 3. Panggil Server
    google.script.run.withSuccessHandler(res => {
        if (!res.success) {
            content.innerHTML = `<div class="p-4 text-center text-red-500 font-bold">${res.message}</div>`;
            return;
        }

        title.innerText = `Lembar Jawaban: ${res.name}`;
        
        // 4. Render Daftar Soal & Jawaban
        let html = '<div class="space-y-4">';
        
        res.data.forEach((item, idx) => {
            // Tentukan Warna Status (Benar/Salah)
            let statusIcon = '';
            let borderClass = 'border-slate-200';
            let bgClass = 'bg-white';

            if (item.type === 'Esai') {
                statusIcon = '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded border border-purple-200 font-bold">ESAI</span>';
                borderClass = 'border-purple-200';
            } else if (item.type === 'JODOH') {
                statusIcon = '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded border border-blue-200 font-bold">MENJODOHKAN</span>';
            } else {
                if (item.isCorrect) {
                    statusIcon = '<span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded border border-emerald-200 font-bold"><i class="fas fa-check mr-1"></i>BENAR</span>';
                    borderClass = 'border-emerald-200';
                    bgClass = 'bg-emerald-50/30';
                } else {
                    statusIcon = '<span class="text-[10px] bg-red-100 text-red-700 px-2 py-0.5 rounded border border-red-200 font-bold"><i class="fas fa-times mr-1"></i>SALAH</span>';
                    borderClass = 'border-red-200';
                    bgClass = 'bg-red-50/30';
                }
            }

            // Render Gambar Soal jika ada
            let imgHtml = item.image ?
            `<div class="mb-3"><img src="${item.image}" referrerpolicy="no-referrer" class="max-h-40 rounded border border-slate-200"></div>` : '';

            html += `
            <div class="p-4 rounded-xl border ${borderClass} ${bgClass} transition hover:shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-bold text-slate-400 uppercase">No. ${idx + 1}</span>
                    ${statusIcon}
                </div>
                
                <div class="mb-3 text-slate-800 font-medium text-sm leading-relaxed">
                    ${item.q}
                </div>
                ${imgHtml}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-3 pt-3 border-t border-slate-100">
                    <div class="bg-white p-3 rounded border border-slate-200">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Jawaban Siswa</p>
                        <p class="font-bold ${item.isCorrect === true ? 'text-emerald-600' : (item.type === 'Esai' ? 'text-slate-700' : 'text-red-600')}">
                            ${item.studentAns}
                        </p>
                    </div>
                    <div class="bg-slate-50 p-3 rounded border border-slate-200">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Kunci Jawaban</p>
                        <p class="font-mono text-slate-600 font-medium break-words">
                            ${item.type === 'Esai' ? '(Kebijakan Guru)' : item.key}
                        </p>
                    </div>
                </div>
            </div>`;
        });
        
        html += '</div>';
        content.innerHTML = html;

    }).getStudentAnswerDetail(responseId);
}

function closeViewAnswersModal() {
    document.getElementById('modal-view-answers').classList.add('hidden');
}

// Fungsi untuk Membuat Modal HTML secara dinamis (Inject ke Body)
function createViewAnswersModal() {
    const modalHtml = `
    <div id="modal-view-answers" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeViewAnswersModal()"></div>
        
        <div class="relative w-full max-w-3xl bg-white rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-[fadeIn_0.3s_ease-out] z-[101]">
            <div class="px-6 py-4 border-b flex justify-between items-center bg-teal-50 rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-teal-100 text-teal-600 flex items-center justify-center"><i class="fas fa-list-check"></i></div>
                    <h3 class="font-bold text-lg text-teal-900" id="view-answers-title">Detail Jawaban</h3>
                </div>
                <button onclick="closeViewAnswersModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar bg-slate-50" id="view-answers-content">
                </div>
            
            <div class="p-4 border-t bg-white rounded-b-2xl flex justify-end">
                <button onclick="closeViewAnswersModal()" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-bold text-sm transition">
                    Tutup
                </button>
            </div>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function renderInternalTable() {
    const container = document.getElementById('res-table-container');
    const infoDisplay = document.getElementById('pagination-info');
    const btnPrev = document.getElementById('btn-page-prev');
    const btnNext = document.getElementById('btn-page-next');

    // A. Cek Jika Data Kosong (Setelah difilter atau memang kosong)
    if (filteredResults.length === 0) {
        container.innerHTML = `
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-16 text-center w-full">
                <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-100">
                    <i class="fas fa-inbox text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-slate-700 font-bold text-lg">Data Tidak Ditemukan</h3>
                <p class="text-slate-400 text-sm mt-1">Coba kata kunci lain atau belum ada siswa ujian.</p>
            </div>`;
        
        if(infoDisplay) infoDisplay.innerText = 'Menampilkan 0 data';
        if(btnPrev) btnPrev.disabled = true;
        if(btnNext) btnNext.disabled = true;
        return;
    }

    // B. Hitung Logika Pagination
    const totalData = filteredResults.length;
    const maxPage = Math.ceil(totalData / rowsPerPage);
    
    // Validasi Current Page
    if (currentPage > maxPage) currentPage = maxPage;
    if (currentPage < 1) currentPage = 1;

    // Tentukan index slice (potong array)
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, totalData);
    
    // Ambil data hanya untuk halaman ini
    const pageData = filteredResults.slice(startIndex, endIndex);

    // C. Generate HTML Baris Tabel
    let rowsHtml = pageData.map((r, i) => {
         // Hitung nomor urut asli (mengikuti halaman)
         const realIndex = startIndex + i + 1;
         
         // --- LOGIKA STATUS ---
         const isCheat = r.status === 'Curang';
         const isDone = r.status === 'Completed' || r.status === 'Selesai';
         
         let statusBadge = '';
         let actionBtn = '';
         let scoreColor = 'text-slate-700';

         if (isCheat) {
             // KONDISI 1: CURANG -> Badge Merah & Tombol Reset
             statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-200 uppercase tracking-wide"><i class="fas fa-exclamation-triangle"></i> CURANG</span>`;
             scoreColor = 'text-red-600 line-through opacity-50'; 
             
             actionBtn = `
               <button onclick="resetExamAttempt('${r.responseId}', '${r.name}')" class="inline-flex items-center justify-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold text-white bg-orange-500 hover:bg-orange-600 shadow-sm transition-all transform active:scale-95" title="Hapus data agar siswa bisa ujian lagi">
                <i class="fas fa-redo-alt"></i> Ujian Ulang
               </button>`;

         } else if (isDone) {
             // KONDISI 2: SELESAI NORMAL -> Badge Hijau & Tombol Aksi Lengkap
             statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Selesai</span>`;
             
             // Pewarnaan Nilai
             scoreColor = r.score >= 75 ? 'text-emerald-600' : (r.score < 50 ? 'text-red-600' : 'text-orange-600');
             
             // --- TOMBOL AKSI LENGKAP (View, Print, Grade) ---
             actionBtn = `
               <div class="flex items-center justify-end gap-2">
                   <button onclick="viewStudentAnswers('${r.responseId}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-teal-600 bg-teal-50 hover:bg-teal-100 border border-teal-200 hover:border-teal-300 transition-all shadow-sm" title="Lihat Jawaban Siswa">
                    <i class="fas fa-eye"></i>
                   </button>
                   
                   <button onclick="downloadStudentPDF('${r.responseId}', this)" class="w-8 h-8 flex items-center justify-center rounded-lg text-purple-600 bg-purple-50 hover:bg-purple-100 border border-purple-200 hover:border-purple-300 transition-all shadow-sm" title="Download PDF Jawaban">
                    <i class="fas fa-print"></i>
                   </button>

                   <button onclick="openGradingModal('${r.responseId}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-blue-600 bg-blue-50 hover:bg-blue-100 border border-blue-200 hover:border-blue-300 transition-all shadow-sm" title="Koreksi Esai & Nilai">
                    <i class="fas fa-pencil-alt"></i>
                   </button>
               </div>`;

         } else {
             // KONDISI 3: STATUS LAIN (Sedang Mengerjakan)
             statusBadge = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-yellow-50 text-yellow-700 border border-yellow-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></span>Ujian</span>`;
             actionBtn = `<span class="text-slate-300 text-[10px] uppercase font-bold tracking-wider">-</span>`;
         }

         return `
         <tr class="border-b border-slate-50 hover:bg-slate-50/80 transition-colors duration-200 group">
            <td class="p-5 text-center text-slate-400 text-sm font-medium w-16">${realIndex}</td>
            <td class="p-5">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 text-sm font-bold border border-slate-200">
                        ${r.name.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition-colors">${r.name}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] font-mono text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">${r.studentId}</span>
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-5 text-sm text-slate-500 font-medium">
                <div class="flex items-center gap-2">
                    <i class="far fa-clock text-slate-300"></i> ${r.submitTime}
                </div>
            </td>
            <td class="p-5">
                <div class="text-lg font-black ${scoreColor} tracking-tight">${r.score}</div>
            </td>
            <td class="p-5 text-center">${statusBadge}</td>
            <td class="p-5 text-right w-36">
                ${actionBtn}
            </td>
         </tr>
      `;
    }).join('');

    // D. Update HTML Container Tabel
    container.innerHTML = `
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden w-full">
            <div class="overflow-x-auto w-full">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm">
                            <th class="py-4 px-2 text-center w-16">No</th>
                            <th class="py-4 px-5">Identitas Siswa</th>
                            <th class="py-4 px-5 w-40">Waktu Submit</th>
                            <th class="py-4 px-5 w-24">Nilai</th>
                            <th class="py-4 px-5 text-center w-32">Status</th>
                            <th class="py-4 px-5 text-right w-36">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 bg-white">${rowsHtml}</tbody>
                </table>
            </div>
        </div>`;

    // E. Update Info Pagination & State Tombol
    if(infoDisplay) {
        infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;
    }
    
    if(btnPrev) {
        btnPrev.disabled = (currentPage === 1);
        if(currentPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
        else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    if(btnNext) {
        const isLastPage = (currentPage === maxPage || maxPage === 0);
        btnNext.disabled = isLastPage;
        if(isLastPage) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
        else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}
    // --- 3. STUDENT EXAM LOGIC ---
    function initStudentExam(examData) {
      // --- MODIFIKASI: Peringatan Keras Sebelum Masuk ---
      Swal.fire({
        title: 'PERHATIAN SEBELUM UJIAN',
        html: `
            <div class="text-left mt-2">
                <p class="text-slate-600 mb-3 font-medium">Sistem ini sangat sensitif. Demi kelancaran ujian:</p>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded text-sm text-red-700 font-bold mb-4 shadow-sm">
                    <ul class="list-disc list-inside space-y-1">
                        <li>JANGAN mencoba membuka tab lain.</li>
                        <li>JANGAN keluar dari mode Full Screen.</li>
                        <li>JANGAN melakukan minimize browser.</li>
                    </ul>
                </div>
                <p class="text-slate-500 text-sm">
                    Jika terdeteksi, ujian akan <b class="text-red-600">tertutup otomatis</b> dan jawaban Anda langsung dikirim tanpa peringatan kedua.
                </p>
            </div>
        `,
        icon: 'warning',
        confirmButtonText: 'SAYA MENGERTI & MULAI',
        confirmButtonColor: '#d33', // Warna merah agar siswa waspada
        allowOutsideClick: false,
        allowEscapeKey: false,
        backdrop: `rgba(0,0,0,0.85)` // Latar belakang gelap fokus
      }).then((result) => {
        // Hanya jalankan jika tombol ditekan
        if (result.isConfirmed) {
            violationCount = 0;
            currentExam = examData;
            
            // Pindah Halaman & Masuk Fullscreen
            switchPage('page-exam'); 
            enterFullscreen(); // Browser butuh interaksi user (klik tombol alert) untuk bisa fullscreen

            // Set Data Tampilan
            document.getElementById('exam-subject-title').textContent = examData.subject;
            document.getElementById('student-name-display').textContent = currentUser.username;
            document.getElementById('student-id-display').textContent = currentUser.userID;

            // Ambil Soal dari Server
            google.script.run.withSuccessHandler(res => {
                if(res.error) { 
                    Swal.fire('Gagal', res.error, 'error').then(() => logout()); 
                    return; 
                }
                
                questions = res.questions; 
                if (res.savedAnswers) answers = res.savedAnswers;
                
                renderNavGrid(); 
                renderQuestion(0); 
                startTimer(examData.duration); 
                enableAntiCheat(); // Nyalakan sistem keamanan

            }).getExamQuestions(examData.id, currentUser.userID, currentUser.token);
        }
      });
    }

function downloadStudentPDF(responseId, btnElement) {
    const originalHtml = btnElement.innerHTML;
    
    // Tampilkan Loading di Tombol
    btnElement.disabled = true;
    btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    google.script.run.withSuccessHandler(res => {
        // Reset Tombol
        btnElement.disabled = false;
        btnElement.innerHTML = originalHtml;

        if (res.success) {
            // Buka PDF
            window.open(res.url, '_blank');
        } else {
            Swal.fire('Gagal', res.message, 'error');
        }
    }).withFailureHandler(err => {
        btnElement.disabled = false;
        btnElement.innerHTML = originalHtml;
        Swal.fire('Error', err.message, 'error');
    }).generateStudentDetailPDF(responseId);
}

// --- RENDER QUESTION (Updated UI) ---
function renderQuestion(index) {
  currentQIndex = index; 
  const q = questions[index];
  
  if(q.type === 'JODOH' && (!answers[q.id] || typeof answers[q.id] !== 'object')) { 
      answers[q.id] = {};
  }
  
  const savedAns = answers[q.id];

  // --- UKURAN FONT DIKECILKAN DI SINI ---
  let html = `
    <div class="flex items-start justify-between mb-4">
        <div>
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-0.5 block">Pertanyaan No.</span>
            <h2 class="text-xl font-bold text-slate-800">${index+1}</h2>
        </div>
        <div class="flex flex-col items-end gap-1">
             <span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-100">${q.type}</span>
             ${(String(q.isRequired) === 'TRUE') ? '<span class="text-[10px] text-red-500 font-bold bg-red-50 px-2 py-0.5 rounded border border-red-100">WAJIB</span>' : ''}
        </div>
    </div>
    
    <div class="question-text text-base text-slate-700 leading-relaxed font-medium mb-6">
        ${q.content}
    </div>`;

  if(q.image) {
    html += `
    <div class="mb-6 p-1.5 border border-slate-100 rounded-xl bg-slate-50 inline-block">
      <img src="${q.image}" referrerpolicy="no-referrer" class="max-w-full h-auto max-h-[350px] rounded-lg cursor-pointer hover:opacity-95 transition" onclick="window.open(this.src)">
    </div>`;
  }
  
  
  html += '<div class="space-y-2.5">'; // Jarak antar opsi diperkecil (space-y-2.5)

  // -- Tipe: PG / BS --
  if(q.type === 'PG' || q.type === 'BS') {
     q.options.forEach((opt, idx) => {
        const isChecked = savedAns === opt;
        const alphabet = String.fromCharCode(65 + idx); 
        
        // Opsi Jawaban: text-sm (sebelumnya base) & padding dikurangi (py-3 px-4)
        html += `
        <div class="option-label ${isChecked ? 'checked' : ''} py-3 px-4" onclick="selectOption('${q.id}', '${opt.replace(/'/g, "\\'")}', this)">
            <div class="custom-radio w-5 h-5 mr-3"></div> <div class="flex-1">
                <span class="font-bold text-slate-400 mr-2 text-xs select-none">${alphabet}.</span>
                <span class="text-slate-700 font-medium text-sm">${opt}</span>
            </div>
            <input type="radio" name="ans_${q.id}" value="${opt}" class="hidden"> 
        </div>`;
     });
  } 
  // -- Tipe: JODOH --
    else if(q.type === 'JODOH') {
        const pairs = q.options;
        const lefts = pairs.map(p => p.q);
        // Sort acak sisi kanan
        let rights = pairs.map(p => p.a).sort(() => Math.random() - 0.5);

        html += `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-xl border border-slate-200">
            <div class="space-y-2 bg-cyan-50/50 p-3 rounded-xl border border-cyan-100">
                <p class="text-[10px] text-cyan-600 font-bold mb-1 uppercase tracking-wide text-center">
                    <i class="fas fa-question-circle mr-1"></i> Bagian Kiri
                </p>
                ${lefts.map(it => `
                    <button onclick="selectMatchLeft('${q.id}','${it}',this)" 
                    class="match-left w-full p-3 bg-white border border-cyan-200 rounded-lg text-left hover:bg-cyan-50 hover:border-cyan-400 transition text-xs md:text-sm font-medium text-slate-700 shadow-sm ${savedAns[it] ? '!bg-emerald-100 !border-emerald-500 !text-emerald-800' : ''}">
                    ${it}
                    </button>
                `).join('')}
            </div>

            <div class="space-y-2 bg-amber-50/50 p-3 rounded-xl border border-amber-100">
                <p class="text-[10px] text-amber-600 font-bold mb-1 uppercase tracking-wide text-center">
                    <i class="fas fa-check-circle mr-1"></i> Bagian Kanan
                </p>
                ${rights.map(it => `
                    <button onclick="selectMatchRight('${q.id}','${it}',this)" 
                    class="match-right w-full p-3 bg-white border border-amber-200 rounded-lg text-left hover:bg-amber-50 hover:border-amber-400 transition text-xs md:text-sm font-medium text-slate-700 shadow-sm ${Object.values(savedAns).includes(it) ? '!bg-amber-200 !border-amber-500 !text-amber-900 ring-1 ring-amber-500' : ''}">
                    ${it}
                    </button>
                `).join('')}
            </div>
        </div>`;
    }
  // -- Tipe: Esai --
  else {
     html += `<textarea class="w-full border border-slate-300 rounded-xl p-4 h-40 focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none transition text-sm text-slate-700 leading-relaxed shadow-inner bg-slate-50 focus:bg-white" onblur="saveAnswer('${q.id}',this.value)" placeholder="Ketik jawaban Anda di sini...">${savedAns || ''}</textarea>`;
  }
  
  html += '</div>';
  document.getElementById('question-container').innerHTML = html;
  
  // Logic Tombol (Sama seperti sebelumnya)
  document.getElementById('btn-prev').disabled = (index === 0);
  document.getElementById('btn-prev').classList.toggle('opacity-50', index === 0);
  
  const btnNext = document.getElementById('btn-next');
  if (index === questions.length - 1) {
      btnNext.innerHTML = 'Selesai <i class="fas fa-flag-checkered ml-2"></i>';
      btnNext.classList.replace('bg-blue-600', 'bg-emerald-600');
      btnNext.classList.replace('hover:bg-blue-700', 'hover:bg-emerald-700');
      btnNext.setAttribute('onclick', 'finishExamManual()');
  } else {
      btnNext.innerHTML = 'Selanjutnya <i class="fas fa-arrow-right ml-2"></i>';
      btnNext.classList.replace('bg-emerald-600', 'bg-blue-600');
      btnNext.classList.replace('hover:bg-emerald-700', 'hover:bg-blue-700');
      btnNext.setAttribute('onclick', 'nextQ()');
  }
  updateNavStyle();
  document.getElementById('main-exam-area').scrollTo(0,0);
}

// Fungsi helper baru untuk seleksi opsi yang lebih smooth
function selectOption(qid, val, el) {
    // Hapus class checked dari semua sibling
    const siblings = el.parentElement.querySelectorAll('.option-label');
    siblings.forEach(sib => sib.classList.remove('checked'));
    
    // Tambah class checked ke elemen yang diklik
    el.classList.add('checked');
    
    // Simpan jawaban
    saveAnswer(qid, val);
}

// --- RENDER NAV GRID (Updated UI) ---
function renderNavGrid() {
  // Grid cols-5 dengan gap lebih rapat (gap-2)
  document.getElementById('nav-grid').innerHTML = questions.map((q, i) => 
    `<button id="nav-btn-${i}" onclick="renderQuestion(${i})" class="nav-btn-modern">
        ${i+1}
     </button>`
  ).join('');
  updateNavStyle();
}




// --- HELPER FILTER & PAGINATION BANK SOAL ---

function handleQuestionSearch(keyword) {
    const term = keyword.toLowerCase().trim();
    // Filter dari data master allQuestionsData
    filteredQuestions = allQuestionsData.filter(q => {
        return q.content.toLowerCase().includes(term) || 
               q.type.toLowerCase().includes(term) ||
               (q.key && q.key.toLowerCase().includes(term));
    });
    currentQPage = 1; // Reset ke halaman 1
    // Ambil ID Exam dari hidden input untuk parameter delete (walau di renderInternal logic delete pakai value input langsung)
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

function changeQRowsPerPage(val) {
    if (val === 'all') {
        qRowsPerPage = filteredQuestions.length > 0 ? filteredQuestions.length : 10;
    } else {
        qRowsPerPage = parseInt(val);
    }
    currentQPage = 1;
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

function changeQPage(direction) {
    if (direction === 'prev') {
        if (currentQPage > 1) currentQPage--;
    } else if (direction === 'next') {
        const maxPage = Math.ceil(filteredQuestions.length / qRowsPerPage);
        if (currentQPage < maxPage) currentQPage++;
    }
    const eid = document.getElementById('input-exam-id').value;
    renderQuestionsInternal(eid);
}

// --- UPDATE NAV STYLE (Logic coloring) ---
function updateNavStyle() {
  questions.forEach((q, i) => {
     const btn = document.getElementById(`nav-btn-${i}`);
     if (btn) {
         let isAns = answers[q.id]; 
         if(typeof isAns === 'object') isAns = Object.keys(isAns).length > 0;
         else if (typeof isAns === 'string') isAns = isAns.trim() !== '';

         // Reset class base
         btn.className = 'nav-btn-modern';

         if (i === currentQIndex) {
             btn.classList.add('current');
         } else if (isAns) {
             btn.classList.add('answered');
         }
     }
  });
}

    function selectMatchLeft(qid, val, el) {
        // Hapus efek aktif dari semua tombol kiri (hapus bg-cyan-200)
        document.querySelectorAll('.match-left').forEach(b => b.classList.remove('ring-2','ring-cyan-500','bg-cyan-200'));
        
        // Tambahkan efek aktif ke tombol yang diklik (gunakan bg-cyan-200 agar lebih gelap dari base)
        el.classList.add('ring-2','ring-cyan-500','bg-cyan-200');
        selectedLeft = val;
    }
    
    function selectMatchRight(qid, val, el) {
        if(!selectedLeft) { Swal.fire('Info','Pilih sisi kiri dulu!','info'); return; }
        if(!answers[qid]) answers[qid] = {}; answers[qid][selectedLeft] = val; selectedLeft = null;
        renderQuestion(currentQIndex); google.script.run.syncAnswers(currentUser.userID, currentExam.id, answers, violationCount);
    }

    function saveAnswer(qid, val) {
      answers[qid] = val; updateNavStyle(); google.script.run.syncAnswers(currentUser.userID, currentExam.id, answers, violationCount);
    }

    function renderNavGrid() {
      document.getElementById('nav-grid').innerHTML = questions.map((q, i) => `<button id="nav-btn-${i}" onclick="renderQuestion(${i})" class="w-full aspect-square border rounded-lg flex items-center justify-center font-bold text-sm transition hover:shadow-md">${i+1}</button>`).join('');
      updateNavStyle();
    }

    function updateNavStyle() {
      questions.forEach((q, i) => {
         const btn = document.getElementById(`nav-btn-${i}`);
         if (btn) {
             let isAns = answers[q.id]; if(typeof isAns === 'object') isAns = Object.keys(isAns).length > 0;
             btn.className = `w-full aspect-square border rounded-lg flex items-center justify-center font-bold text-sm transition ${i===currentQIndex ? 'bg-yellow-100 border-yellow-400 ring-2 ring-yellow-300 text-yellow-800 scale-105 shadow' : (isAns ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50')}`;
         }
      });
    }

    function prevQ() { if(currentQIndex > 0) renderQuestion(currentQIndex - 1); }
    function nextQ() {
        // --- VALIDASI NAVIGASI KETAT ---
        const q = questions[currentQIndex];
        // Cek apakah soal ini wajib
        const isReq = String(q.isRequired).toUpperCase().trim() === 'TRUE';
        
        if (isReq) {
            const hasAnswer = answers[q.id] && String(answers[q.id]).trim() !== '';
            const isObjFilled = typeof answers[q.id] === 'object' && Object.keys(answers[q.id]).length > 0;
            
            // Jika wajib tapi kosong, munculkan peringatan & batalkan pindah halaman
            if ((q.type === 'JODOH' && !isObjFilled) || (q.type !== 'JODOH' && !hasAnswer)) {
                const Toast = Swal.mixin({ toast: true, position: 'center', showConfirmButton: false, timer: 1500 });
                Toast.fire({ icon: 'warning', title: 'Soal ini wajib diisi dulu!' });
                return; // STOP, JANGAN PINDAH
            }
        }
        // -------------------------------

        if(currentQIndex < questions.length - 1) {
            renderQuestion(currentQIndex + 1);
        }
    }
    function toggleExamNav() { document.getElementById('exam-nav').classList.toggle('translate-x-full'); }

    // --- ANTI-CHEAT & SYSTEM ---
    function enableAntiCheat() {
      console.log("Anti-Cheat Aktif");
      ac_ctxHandler = e => e.preventDefault();
      ac_keyHandler = e => { if((e.ctrlKey && ['c','v','u','f','p','s'].includes(e.key.toLowerCase())) || e.key === 'Alt' || e.key === 'F12' || e.key === 'F5' || e.key === 'PrintScreen') { e.preventDefault(); e.stopPropagation(); } };
      ac_visHandler = () => { if(document.hidden) handleSecurityTrigger('Pindah Tab / Minimize'); };
      ac_blurHandler = () => { setTimeout(() => { if(!document.hasFocus()) { handleSecurityTrigger('Kehilangan Fokus / Klik Luar'); } }, 500); };
      ac_fsHandler = () => { if (!document.fullscreenElement && !document.webkitFullscreenElement) { const examPage = document.getElementById('page-exam'); if (examPage && !examPage.classList.contains('hidden')) { handleSecurityTrigger('Keluar dari Mode Fullscreen'); } } };
      ac_unloadHandler = (e) => { e.preventDefault(); e.returnValue = ''; };
      document.addEventListener('contextmenu', ac_ctxHandler); document.addEventListener('keydown', ac_keyHandler); document.addEventListener('visibilitychange', ac_visHandler); window.addEventListener('blur', ac_blurHandler); document.addEventListener('fullscreenchange', ac_fsHandler); document.addEventListener('webkitfullscreenchange', ac_fsHandler); window.addEventListener('beforeunload', ac_unloadHandler);
    }

    function disableAntiCheat() {
      console.log("Anti-Cheat Dimatikan");
      document.removeEventListener('contextmenu', ac_ctxHandler); document.removeEventListener('keydown', ac_keyHandler); document.removeEventListener('visibilitychange', ac_visHandler); window.removeEventListener('blur', ac_blurHandler); document.removeEventListener('fullscreenchange', ac_fsHandler); document.removeEventListener('webkitfullscreenchange', ac_fsHandler); window.removeEventListener('beforeunload', ac_unloadHandler);
      document.getElementById('warning-overlay').style.display = 'none'; document.getElementById('warning-overlay').classList.add('hidden');
    }

function handleSecurityTrigger(reason) {
    console.warn("Security Triggered: " + reason);

    // 1. Log Pelanggaran ke Server (Penting untuk bukti)
    if (currentUser && currentExam) {
        google.script.run.logViolation(currentUser.userID, currentExam.id, 1, reason);
    }

    // 2. Matikan sistem keamanan agar alert tidak spam
    disableAntiCheat();
    
    // 3. Matikan Timer
    if (timerInterval) clearInterval(timerInterval);

    // 4. Force Submit dengan Status 'Curang'
    // Parameter: (forced=true, statusLabel='Curang')
    finishExamManual(true, 'Curang');

    // 5. Tampilkan Alert Diskualifikasi
    Swal.fire({
        title: 'DISKUALIFIKASI!',
        html: `
            <div class="text-left mt-2">
                <p class="text-slate-600 mb-3">Sistem mendeteksi aktivitas terlarang:</p>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r mb-4 shadow-sm">
                    <p class="text-red-700 font-bold flex items-center gap-2 text-lg">
                        <i class="fas fa-exclamation-triangle"></i> ${reason}
                    </p>
                </div>
                <p class="text-sm text-slate-500 leading-relaxed">
                    Ujian dihentikan otomatis. Status Anda tercatat sebagai <b>CURANG</b>.
                </p>
            </div>
        `,
        icon: 'error',
        allowOutsideClick: false,
        allowEscapeKey: false,
        confirmButtonText: 'Tutup Aplikasi',
        confirmButtonColor: '#d33',
        width: '500px'
    }).then((result) => {
        if (result.isConfirmed) {
            logout();
        }
    });
}

    function resumeExamFromViolation() {
      const overlay = document.getElementById('warning-overlay'); overlay.style.display = 'none'; overlay.classList.add('hidden'); enterFullscreen();
    }

    function enterFullscreen() { const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }

    function startTimer(dur) {
       let t = parseInt(dur) * 60;
       if(isNaN(t) || t<=0) { t = 60 * 60; }
       
       if(timerInterval) clearInterval(timerInterval);
       
       const timerDisplay = document.getElementById('timer-display');        // ID Desktop
       const timerMobile = document.getElementById('timer-display-mobile');  // ID Mobile
       
       timerInterval = setInterval(() => {
          const h = Math.floor(t/3600);
          const m = Math.floor((t%3600)/60);
          const s = t%60;
          
          // Format 00:00:00
          const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
          // Format Pendek 00:00 (Untuk Mobile jika jam 0)
          const timeStrShort = h > 0 ? timeStr : `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

          // Update Tampilan Desktop
          if(timerDisplay) timerDisplay.innerText = timeStr;
          
          // Update Tampilan Mobile (PERBAIKAN DISINI)
          if(timerMobile) timerMobile.innerText = timeStrShort;

          // Waktu Habis
          if(--t < 0) { 
              clearInterval(timerInterval); 
              finishExamManual(true, 'Waktu Habis'); 
          }
       }, 1000);
    }

/* MODIFIKASI: finishExamManual */
function finishExamManual(forced = false, statusLabel = 'Completed') {
   // 1. Jika dipaksa (Waktu habis atau Curang)
   if (forced) { 
       // Langsung eksekusi submit tanpa validasi soal wajib
       executeSubmission(true, statusLabel); 
       return; 
   }

   // 2. Validasi Soal Wajib (Hanya jika submit manual normal)
   const emptyRequired = [];
   questions.forEach((q, index) => {
       const isReq = String(q.isRequired).toUpperCase().trim() === 'TRUE';
       
       const hasAnswer = answers[q.id] && String(answers[q.id]).trim() !== '';
       const isObjFilled = typeof answers[q.id] === 'object' && Object.keys(answers[q.id]).length > 0;
       
       if (isReq) {
           if ((q.type === 'JODOH' && !isObjFilled) || (q.type !== 'JODOH' && !hasAnswer)) {
               emptyRequired.push(index + 1);
           }
       }
   });

   // 3. Jika ada soal wajib yang kosong, tolak submit
   if (emptyRequired.length > 0) {
       Swal.fire({
           title: 'Jawaban Belum Lengkap!',
           html: `<p>Anda tidak bisa mengumpulkan ujian karena soal berikut wajib diisi:</p><br><b class="text-red-600 text-xl">Nomor: ${emptyRequired.join(', ')}</b>`,
           icon: 'error',
           confirmButtonText: 'Lengkapi Jawaban',
           confirmButtonColor: '#d33'
       });
       return; 
   }

   // 4. Konfirmasi Submit Normal
   Swal.fire({ 
       title: 'Selesai Ujian?', 
       text: "Yakin ingin mengumpulkan jawaban?", 
       icon: 'question', 
       showCancelButton: true, 
       confirmButtonColor: '#2563eb', 
       cancelButtonColor: '#d33', 
       confirmButtonText: 'Ya, Kumpulkan!', 
       cancelButtonText: 'Batal' 
   }).then((result) => { 
       if (result.isConfirmed) { 
           // Submit normal statusnya pasti 'Completed'
           executeSubmission(false, 'Completed'); 
       } 
   });
}

function resetQuestionForm() {
    const form = document.querySelector('form[onsubmit="handleAddQuestion(event)"]');
    if(form) form.reset();
    
    // Kosongkan ID agar kembali ke mode Add Baru
    document.getElementById('input-question-id').value = '';

    // --- LOGIKA BARU: RESET DROPDOWN UKURAN ---
    if(document.getElementById('input-image-size')) {
        document.getElementById('input-image-size').value = 'w1000'; // Default Besar
    }
    // ------------------------------------------

    // Reset Tombol kembali ke warna Biru (Simpan Soal)
    const btn = document.querySelector('button[type="submit"]');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-save"></i> Simpan Pertanyaan'; 
        btn.classList.remove('bg-orange-600', 'hover:bg-orange-700');
        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    }

    // Reset Opsi Tampilan ke default (PG)
    toggleOptionsInput('PG'); 
    
    // Bersihkan container jodoh jika ada sisa elemen
    const pairContainer = document.getElementById('pairs-container');
    if(pairContainer) {
        pairContainer.innerHTML = `
           <div class="grid grid-cols-2 gap-3">
               <input type="text" class="pair-left border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Pertanyaan (Kiri)">
               <input type="text" class="pair-right border border-slate-200 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Jawaban (Kanan)">
           </div>`;
    }
}

/* --- FUNGSI ISI FORM SAAT EDIT --- */
function editQuestion(qStr) {
    // Decode data soal dari string JSON
    const q = JSON.parse(decodeURIComponent(qStr));

    // 1. Buka Tab Manual & Scroll ke atas
    document.getElementById('form-add-q').classList.remove('hidden');
    document.getElementById('form-import-q').classList.add('hidden');
    document.getElementById('form-import-excel').classList.add('hidden');
    document.getElementById('form-add-q').scrollIntoView({ behavior: 'smooth' });

    // 2. Isi Form Dasar
    document.getElementById('input-question-id').value = q.id;
    document.querySelector('select[name="type"]').value = q.type;
    document.querySelector('textarea[name="content"]').value = q.content;
    document.querySelector('input[name="image"]').value = q.image || '';

    // --- LOGIKA BARU: DETEKSI UKURAN GAMBAR SAAT EDIT ---
    const sizeSelect = document.getElementById('input-image-size');
    if (sizeSelect) {
        if (q.image) {
            if (q.image.includes('sz=w300')) {
                sizeSelect.value = 'w300'; // Set ke Kecil
            } else if (q.image.includes('sz=w600')) {
                sizeSelect.value = 'w600'; // Set ke Sedang
            } else {
                sizeSelect.value = 'w1000'; // Set ke Besar (Default)
            }
        } else {
            sizeSelect.value = 'w1000'; // Default jika tidak ada gambar
        }
    }
    // ----------------------------------------------------

    document.getElementById('correct-input').value = q.key;
    
    // Perbaikan seleksi status Wajib (TRUE/FALSE)
    const reqSelect = document.querySelector('select[name="isRequired"]');
    if(reqSelect) {
        const val = String(q.isRequired).toUpperCase().trim();
        reqSelect.value = (val === 'TRUE') ? 'TRUE' : 'FALSE';
    }

    // 3. Atur Tampilan Opsi berdasarkan Tipe (PG/JODOH dll)
    toggleOptionsInput(q.type);

    // 4. Isi Opsi Khusus (PG / Jodoh)
    let options = [];
    try {
        options = (typeof q.options === 'string') ? JSON.parse(q.options) : q.options;
    } catch(e) { options = []; }

    if (q.type === 'PG') {
        // Reset kolom opsi dulu
        for(let i=0; i<5; i++) {
             const el = document.getElementById('opt-'+i);
             if(el) el.value = '';
        }
        // Isi kolom opsi
        if(Array.isArray(options)) {
            options.forEach((opt, i) => {
                const el = document.getElementById('opt-'+i);
                if(el && i < 5) el.value = opt;
            });
        }
    } else if (q.type === 'JODOH') {
        const container = document.getElementById('pairs-container');
        container.innerHTML = ''; // Hapus input lama
        
        if(Array.isArray(options)) {
            options.forEach(pair => {
                const div = document.createElement('div');
                div.className = 'grid grid-cols-2 gap-2';
                div.innerHTML = `<input type="text" class="pair-left border p-2 rounded" value="${pair.q}" placeholder="Kiri"><input type="text" class="pair-right border p-2 rounded" value="${pair.a}" placeholder="Kanan">`;
                container.appendChild(div);
            });
        }
    }

    // 5. Ubah Tombol Simpan jadi Mode Edit (Warna Orange)
    const btn = document.querySelector('form[onsubmit="handleAddQuestion(event)"] button[type="submit"]');
    if(btn) {
        btn.innerHTML = '<i class="fas fa-save mr-1"></i> Update Perubahan';
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        btn.classList.add('bg-orange-600', 'hover:bg-orange-700'); 
    }
}

function executeSubmission(forced, statusLabel) {
    // Matikan fitur keamanan & timer
    disableAntiCheat(); 
    clearInterval(timerInterval); 
    
    // Tampilkan Loading
    document.getElementById('global-loading').classList.remove('hidden');

    // Panggil Server
    google.script.run.withSuccessHandler(res => {
        document.getElementById('global-loading').classList.add('hidden');
        
        // Keluar dari fullscreen jika aktif
        if (document.exitFullscreen) document.exitFullscreen().catch(()=>{});

        // Tampilkan Halaman Selesai
        document.getElementById('page-exam').innerHTML = `
        <div class="min-h-screen flex flex-col items-center justify-center bg-white text-center p-6 fade-in">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 mb-6 text-4xl shadow-lg animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-3xl font-bold text-slate-800">Ujian Selesai!</h2>
            <p class="text-slate-500 mt-2">Jawaban Anda telah disimpan ke dalam sistem.</p>
            
            <div class="mt-8 p-6 bg-slate-50 rounded-xl border border-slate-200 min-w-[300px] shadow-sm">
                <p class="text-sm text-slate-500 uppercase font-bold tracking-wide">Status Akhir</p>
                <p class="text-2xl font-bold ${statusLabel === 'Curang' ? 'text-red-600' : 'text-blue-600'} mt-2">
                    ${statusLabel === 'Curang' ? 'DISKUALIFIKASI (CURANG)' : 'SELESAI'}
                </p>
            </div>
            
            <button onclick="logout()" class="mt-8 px-8 py-3 bg-slate-800 hover:bg-slate-900 text-white rounded-lg font-bold transition shadow-lg transform active:scale-95 flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Keluar Aplikasi
            </button>
        </div>`;
        
        // Scroll ke atas
        window.scrollTo(0, 0);

        // Notifikasi Sukses (Hanya jika tidak dipaksa)
        if (!forced) { 
            Swal.fire({
                title: 'Terkirim!', 
                text: 'Jawaban Anda telah disimpan.', 
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
        }
    }).submitExam(currentUser.userID, currentExam.id, answers, statusLabel); // <-- PARAMETER KE-4 PENTING
}

function openGradingModal(responseId) {
        currentGradingId = responseId;
        const modal = document.getElementById('modal-grading');
        const content = document.getElementById('grading-content');
        const nameDisplay = document.getElementById('grading-student-name');
        
        modal.classList.remove('hidden');
        content.innerHTML = '<div class="flex flex-col items-center py-10 text-slate-400"><i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-blue-500"></i> Memuat jawaban esai...</div>';
        document.getElementById('input-essay-score').value = '';

        google.script.run.withSuccessHandler(res => {
            if (!res.success) {
                content.innerHTML = `<div class="text-red-500 text-center p-4">${res.message}</div>`;
                return;
            }

            nameDisplay.innerText = "Siswa: " + res.studentName;

            if (res.data.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-4xl text-green-300 mb-3"></i>
                        <p class="text-slate-600 font-bold">Tidak ada soal Esai.</p>
                        <p class="text-slate-400 text-sm">Nilai sudah otomatis 100% dari Pilihan Ganda.</p>
                    </div>`;
            } else {
                let html = '<div class="space-y-6">';
                res.data.forEach((item, idx) => {
                    html += `
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="flex justify-between mb-2">
                            <span class="text-xs font-bold text-slate-500 uppercase">Soal Esai #${idx+1}</span>
                        </div>
                        <p class="text-slate-800 font-medium mb-3">${item.question}</p>
                        <div class="bg-white p-3 rounded border border-slate-200 text-slate-700 text-sm whitespace-pre-wrap font-serif italic">
                            "${item.answer}"
                        </div>
                    </div>`;
                });
                html += '</div>';
                content.innerHTML = html;
            }
        }).getEssayData(responseId);
    }

    function closeGradingModal() {
        document.getElementById('modal-grading').classList.add('hidden');
        currentGradingId = null;
    }

    function submitEssayGrade() {
        const score = document.getElementById('input-essay-score').value;
        
        // Validasi input
        if (score === '' || score < 0) {
            Swal.fire('Error', 'Masukkan poin esai yang valid (Angka Positif).', 'error');
            return;
        }

        // Efek tombol loading
        const btn = document.querySelector('#modal-grading button[onclick="submitEssayGrade()"]');
        const oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        // Kirim ke server
        google.script.run.withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerHTML = oldText;
            
            if (res.success) {
                closeGradingModal();

                // === BAGIAN UTAMA: UPDATE TABEL TANPA REFRESH ===
                // 1. Cari tombol yang memiliki ID response ini (tombol 'Koreksi' yang tadi diklik)
                // Kita mencari elemen berdasarkan atribut onclick yang berisi ID tersebut
                const rowBtn = document.querySelector(`button[onclick*="${currentGradingId}"]`);
                
                if(rowBtn) {
                    // 2. Cari elemen baris (TR) induk dari tombol tersebut
                    const tr = rowBtn.closest('tr');
                    
                    // 3. Cari kolom Nilai (Kolom ke-4 / index 3) dan update teksnya
                    // Struktur kolom: <td><div class="text-lg font-bold ...">NILAI</div></td>
                    const scoreDiv = tr.querySelectorAll('td')[3].querySelector('div'); 
                    
                    if(scoreDiv) {
                        // Update angka
                        scoreDiv.innerText = res.finalScore;
                        
                        // Tambahkan efek visual (kedip hijau) agar admin sadar nilai berubah
                        scoreDiv.classList.remove('text-blue-600');
                        scoreDiv.classList.add('text-green-600', 'scale-125', 'transition-transform', 'duration-500');
                        
                        setTimeout(() => {
                            scoreDiv.classList.remove('scale-125');
                            // Kembalikan ke warna biru setelah 2 detik (opsional)
                            setTimeout(() => {
                                scoreDiv.classList.remove('text-green-600');
                                scoreDiv.classList.add('text-blue-600');
                            }, 2000);
                        }, 500);
                    }
                }
                // ===============================================

                Swal.fire({
                    title: 'Tersimpan!',
                    text: `Nilai total diperbarui menjadi: ${res.finalScore}`,
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
                
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }).saveEssayGrade(currentGradingId, score);
    }

function checkSavedSession() {
    // 1. Cek apakah ada data sesi di LocalStorage browser
    const savedSession = localStorage.getItem('sipadu_session');

    if (savedSession) {
        try {
            const sess = JSON.parse(savedSession);

            // Jika data tidak lengkap, anggap invalid
            if (!sess.userID || !sess.token) {
                localStorage.removeItem('sipadu_session');
                return;
            }

            // 2. Tampilkan Loading, Sembunyikan Login Form
            // Ini mencegah kedipan (flicker) form login saat me-refresh halaman
            document.getElementById('page-login').classList.add('hidden');
            document.getElementById('global-loading').classList.remove('hidden');

            // 3. Validasi Token ke Server (Wajib ada fungsi checkSession di server/Code.gs)
            google.script.run.withSuccessHandler(res => {
                document.getElementById('global-loading').classList.add('hidden');

                if (res.success) {
                    // === TOKEN VALID ===
                    console.log("Auto-login berhasil sebagai:", res.role);
                    currentUser = res; // Restore user global

                    if (res.role === 'Admin' || res.role === 'Guru') {
                        initAdminPanel();
                    } else {
                        // === LOGIKA KHUSUS SISWA ===
                        // Biasanya siswa tidak boleh auto-login saat ujian berlangsung 
                        // untuk mencegah kecurangan/reset timer yang tidak diinginkan.
                        // Namun jika ingin tetap login, kita arahkan kembali.
                        
                        Swal.fire({
                            title: 'Sesi Dipulihkan',
                            text: 'Silakan masukkan kembali PIN Ujian jika diminta.',
                            icon: 'info',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Demi keamanan ujian, kita hapus sesi siswa agar login manual ulang
                        // (Anda bisa mengubah ini jika ingin siswa langsung masuk)
                        localStorage.removeItem('sipadu_session');
                        document.getElementById('page-login').classList.remove('hidden');
                    }

                } else {
                    // === TOKEN INVALID / EXPIRED ===
                    localStorage.removeItem('sipadu_session'); // Bersihkan data sampah
                    document.getElementById('page-login').classList.remove('hidden');
                    
                    // Opsional: Beritahu user sesi habis
                    // Swal.fire('Sesi Habis', 'Silakan login kembali.', 'warning');
                }
            }).withFailureHandler(err => {
                // Jika gagal koneksi, kembalikan ke login
                console.error("Gagal cek sesi:", err);
                document.getElementById('global-loading').classList.add('hidden');
                document.getElementById('page-login').classList.remove('hidden');
            }).checkSession(sess.userID, sess.token);

        } catch (e) {
            // Jika JSON error
            console.error("Error parsing session:", e);
            localStorage.removeItem('sipadu_session');
            document.getElementById('page-login').classList.remove('hidden');
        }
    } else {
        // Tidak ada sesi tersimpan, biarkan di halaman login
        // Tidak perlu melakukan apa-apa
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 1. --- TAMBAHAN BARU: Simpan kode HTML asli halaman ujian ---
    // Ini penting agar saat logout, kita bisa mengembalikan tampilan ke awal
    const examPageEl = document.getElementById('page-exam');
    if (examPageEl) {
        initialExamHTML = examPageEl.innerHTML;
    }
    // ------------------------------------------------------------

    // 2. Cek Sesi (yang sudah ada sebelumnya)
    checkSavedSession(); 
});

/* -----------------------------------------------------------
   LOGIKA IMPORT EXCEL
   ----------------------------------------------------------- */

function downloadTemplateExcel() {
    const headers = ["Tipe", "Pertanyaan", "Opsi_A", "Opsi_B", "Opsi_C", "Opsi_D", "Opsi_E", "Kunci_Jawaban", "Wajib"];
    
    const sample = [
        // PG Biasa
        ["PG", "Apa warna langit?", "Merah", "Biru", "Hijau", "Kuning", "Hitam", "Biru", "TRUE"],
        // PG Fleksibel
        ["PG", "1 + 1 = ?", "3", "2", "5", "", "", "2", "TRUE"],
        // Benar Salah
        ["BS", "Bumi itu bulat.", "Benar", "Salah", "", "", "", "Benar", "TRUE"],
        // Esai
        ["Esai", "Jelaskan tentang atom.", "", "", "", "", "", "", "FALSE"],
        
        // --- [BARU] CONTOH MENJODOHKAN ---
        // Format: "Pertanyaan=Jawaban"
        ["JODOH", "Pasangkan Negara dan Ibu Kota", "Indonesia=Jakarta", "Jepang=Tokyo", "Inggris=London", "", "", "Auto-Check", "TRUE"]
    ];
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([headers, ...sample]);
    
    // Atur lebar kolom
    ws['!cols'] = [{wch:10}, {wch:40}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:10}];
    
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    XLSX.writeFile(wb, "Template_Soal_Lengkap.xlsx");
}

function processExcelImport() {
    const fileInput = document.getElementById('input-excel-file');
    const examId = document.getElementById('select-exam-q').value;

    if (!examId) {
        Swal.fire('Peringatan', 'Silakan pilih Mata Pelajaran di dropdown atas terlebih dahulu!', 'warning');
        return;
    }

    if (fileInput.files.length === 0) {
        Swal.fire('Peringatan', 'Pilih file Excel (.xlsx) dulu.', 'warning');
        return;
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    const btn = document.querySelector('button[onclick="processExcelImport()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membaca File...';

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            if (rawData.length > 0) rawData.shift(); // Hapus Header

            const questionsToSave = [];

            rawData.forEach((row) => {
                if (row.length === 0) return;

                const type = row[0] ? String(row[0]).trim() : "";
                const content = row[1] ? String(row[1]).trim() : "";

                if (type && content) {
                    let options = [];
                    let key = "";
                    let isReq = "FALSE";

                    // === LOGIKA PILIHAN GANDA ===
                    if (type === 'PG') {
                        const potentialOptions = [row[2], row[3], row[4], row[5], row[6]];
                        options = potentialOptions.filter(opt => opt !== undefined && opt !== null && String(opt).trim() !== "").map(String);
                        key = row[7] ? String(row[7]).trim() : "";
                    
                    // === LOGIKA BENAR SALAH ===
                    } else if (type === 'BS') {
                        options = ["Benar", "Salah"];
                        key = row[7] ? String(row[7]).trim() : "";

                    // === LOGIKA MENJODOHKAN (BARU) ===
                    } else if (type === 'JODOH') {
                        // Ambil kolom opsi, filter yang kosong
                        const rawPairs = [row[2], row[3], row[4], row[5], row[6]];
                        const validStrings = rawPairs.filter(p => p && String(p).trim() !== "");
                        
                        options = validStrings.map(pairStr => {
                            // Pecah string "Indonesia=Jakarta" menjadi ["Indonesia", "Jakarta"]
                            const parts = String(pairStr).split('=');
                            if (parts.length >= 2) {
                                // Gabungkan kembali bagian kanan jika ada "=" lain di dalam jawaban
                                const qSide = parts[0].trim();
                                const aSide = parts.slice(1).join('=').trim();
                                return { q: qSide, a: aSide };
                            }
                            return null;
                        }).filter(item => item !== null); // Hapus yang formatnya salah

                        key = "Auto-Check"; // Kunci otomatis

                    // === LOGIKA ESAI ===
                    } else if (type === 'Esai') {
                        options = [];
                        key = "";
                    }

                    if (row[8]) isReq = String(row[8]).toUpperCase();

                    questionsToSave.push({
                        type: type,
                        content: content,
                        options: options,
                        correct: key,
                        isRequired: isReq,
                        image: ''
                    });
                }
            });

            if (questionsToSave.length === 0) throw new Error("Tidak ada data soal valid.");

            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Mengupload...';
            
            google.script.run
                .withSuccessHandler(res => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    if (res.success) {
                        Swal.fire('Sukses', `Berhasil mengimport ${res.count} soal!`, 'success');
                        fileInput.value = ''; 
                        document.getElementById('form-import-excel').classList.add('hidden');
                        loadQuestionsTable(examId); 
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                })
                .saveImportedQuestions(examId, questionsToSave);

        } catch (err) {
            btn.disabled = false;
            btn.innerHTML = originalText;
            Swal.fire('Error', 'Gagal memproses file: ' + err.message, 'error');
        }
    };
    reader.readAsArrayBuffer(file);
}

// --- FUNGSI ADMIN: RESET UJIAN (UJIAN ULANG) ---
// --- FITUR UJIAN ULANG / RESET ---
function resetExamAttempt(responseId, studentName) {
    // 1. Konfirmasi User
    Swal.fire({
        title: 'Reset Ujian?',
        text: `Apakah Anda yakin ingin menghapus data ujian siswa: ${studentName}? Siswa dapat melakukan ujian kembali setelah ini.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Reset Data'
    }).then((result) => {
        if (result.isConfirmed) {
            // 2. Tampilkan Loading
            Swal.fire({
                title: 'Memproses...',
                text: 'Menghapus data ujian...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 3. Panggil Server
            // PENTING: Kita harus mengirimkan userID dan token admin saat ini agar lolos verifikasi keamanan di server
            google.script.run
                .withSuccessHandler((res) => {
                    if (res.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil',
                            text: res.message,
                            timer: 1500,
                            showConfirmButton: false
                        });
                        
                        // 4. Refresh Tabel Hasil Nilai
                        // Ambil ID ujian yang sedang dipilih dari dropdown
                        const examId = document.getElementById('select-result-exam').value;
                        if (examId) {
                            loadResultsTable(examId);
                        }
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                })
                .withFailureHandler((err) => {
                    Swal.fire('Error Sistem', err.message, 'error');
                })
                .resetStudentExam(responseId, currentUser.userID, currentUser.token); 
                // ^^^ Pastikan nama fungsi ini sama dengan di Code.gs baris 3969
        }
    });
}

// =========================================================================
// RENDER HALAMAN MANAGEMENT USER
// =========================================================================

function renderUserManagement(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-4">
       
       <div class="dash-card p-6">
           <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
               <div>
                   <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                       <i class="fas fa-users-cog text-blue-600"></i> Data Pengguna
                   </h2>
                   <p class="text-sm text-slate-500 mt-1">Kelola akun Siswa, Guru, dan Admin.</p>
               </div>
               
               <div class="flex gap-2 w-full md:w-auto">
                   <button onclick="openImportUserModal()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-file-excel"></i> <span class="hidden sm:inline">Import Excel</span>
                   </button>

                   <button onclick="openUserModal()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-xl text-sm font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                      <i class="fas fa-user-plus"></i> <span class="hidden sm:inline">Tambah User</span>
                   </button>
               </div>
           </div>

           <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50 p-4 rounded-xl border border-slate-200">
               
               <div class="flex items-center gap-2 text-sm text-slate-600">
                   <span>Show</span>
                   <select onchange="changeUserRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 bg-white cursor-pointer">
                       <option value="10">10</option>
                       <option value="25">25</option>
                       <option value="50">50</option>
                       <option value="100">100</option>
                       <option value="all">Semua</option>
                   </select>
                   <span>entries</span>
               </div>

               <div class="relative w-full md:w-64 group">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                     <i class="fas fa-search"></i>
                  </div>
                  <input type="text" id="user-search-input" placeholder="Cari Nama, ID, atau Kelas..." onkeyup="handleUserSearch(this.value)" 
                         class="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm bg-white">
               </div>
           </div>
        </div>

        <div id="user-table-wrapper" class="dash-card border border-slate-200 overflow-hidden min-h-[300px]">
            <div class="flex flex-col items-center justify-center h-full py-10 text-slate-400">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-blue-500"></i> Memuat data user...
            </div>
        </div>

        <div id="user-pagination-controls" class="dash-card p-4 flex flex-col md:flex-row justify-between items-center gap-4 text-sm hidden">
             <div class="text-slate-500 font-medium" id="user-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
             <div class="flex gap-2">
                 <button onclick="changeUserPage('prev')" id="btn-user-prev" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Sebelumnya</button>
                 <button onclick="changeUserPage('next')" id="btn-user-next" class="px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Selanjutnya</button>
             </div>
        </div>
    </div>`;

    // 5. INISIALISASI DATA & MODAL
    
    // Load Data dari Server
    loadUserTable();
    
    // Inject Modal Tambah/Edit User jika belum ada
    if (!document.getElementById('modal-user')) {
        createUserModalHTML();
    }

    // Inject Modal Import Excel jika belum ada
    if (!document.getElementById('modal-import-user')) {
         if(typeof createImportUserModalHTML === 'function') {
             createImportUserModalHTML();
         }
    }
}

// =========================================================================
// LOAD DATA USER (UPDATED SECURITY)
// =========================================================================

function loadUserTable() {
    const wrapper = document.getElementById('user-table-wrapper');
    
    // 1. Cek apakah user sedang login (Objek currentUser harus ada)
    if (!currentUser || !currentUser.userID || !currentUser.token) {
        Swal.fire('Error', 'Sesi Anda tidak valid. Silakan login ulang.', 'error')
        .then(() => location.reload()); // Reload untuk logout
        return;
    }

    // Tampilkan Loading UI
    wrapper.innerHTML = `
        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
           <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i> 
           <p>Memverifikasi akses & mengambil data...</p>
        </div>`;

    // 2. Persiapkan Kunci Keamanan
    const reqID = currentUser.userID;
    const reqToken = currentUser.token;

    // 3. Panggil Server dengan Parameter Keamanan
    google.script.run
        .withSuccessHandler(users => {
            // SIMPAN DATA KE GLOBAL VARIABLES
            allUsersData = users || [];
            filteredUsers = users || [];
            currentUserPage = 1;

            // Reset Input Search jika ada
            const searchInput = document.getElementById('user-search-input');
            if(searchInput) searchInput.value = '';

            // Render Tabel Internal
            renderUserTableInternal();
        })
        .withFailureHandler(error => {
            // Jika validasi server gagal (Hacker/Session Expired)
            console.error("Gagal memuat user:", error);
            
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center h-64 text-red-500 p-4 text-center">
                   <i class="fas fa-shield-alt text-4xl mb-3"></i> 
                   <h3 class="font-bold text-lg">Akses Ditolak</h3>
                   <p class="text-sm text-slate-500 mt-1">${error.message}</p>
                   <button onclick="loadUserTable()" class="mt-4 px-4 py-2 bg-slate-200 text-slate-700 rounded hover:bg-slate-300 text-sm font-bold">Coba Lagi</button>
                </div>`;
                
            Swal.fire({
                icon: 'error',
                title: 'Keamanan',
                text: 'Gagal memuat data: ' + error.message
            });
        })
        .getUserList(reqID, reqToken); // <--- INI BAGIAN PENTING (Kirim ID & Token)
}

// --- HELPER FILTER & PAGINATION USER ---

    function handleUserSearch(keyword) {
        const term = keyword.toLowerCase().trim();
        
        // Filter array global
        filteredUsers = allUsersData.filter(u => {
            return u.username.toLowerCase().includes(term) || 
                   String(u.id).toLowerCase().includes(term) ||
                   String(u.class).toLowerCase().includes(term) ||
                   u.role.toLowerCase().includes(term);
        });

        currentUserPage = 1; // Reset ke halaman 1
        renderUserTableInternal();
    }

    function changeUserRowsPerPage(val) {
        if (val === 'all') {
            userRowsPerPage = filteredUsers.length > 0 ? filteredUsers.length : 10;
        } else {
            userRowsPerPage = parseInt(val);
        }
        currentUserPage = 1; 
        renderUserTableInternal();
    }

    function changeUserPage(direction) {
        const maxPage = Math.ceil(filteredUsers.length / userRowsPerPage);
        
        if (direction === 'prev') {
            if (currentUserPage > 1) currentUserPage--;
        } else if (direction === 'next') {
            if (currentUserPage < maxPage) currentUserPage++;
        }
        renderUserTableInternal();
    }
    
    function renderUserTableInternal() {
        const wrapper = document.getElementById('user-table-wrapper');
        const paginationControls = document.getElementById('user-pagination-controls');
        const infoDisplay = document.getElementById('user-pagination-info');
        const btnPrev = document.getElementById('btn-user-prev');
        const btnNext = document.getElementById('btn-user-next');

        // A. Cek Jika Data Kosong
        if (filteredUsers.length === 0) {
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center py-16 text-slate-400">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                        <i class="fas fa-user-slash text-2xl text-slate-300"></i>
                    </div>
                    <p>Tidak ada data user ditemukan.</p>
                </div>`;
            paginationControls.classList.add('hidden');
            return;
        }

        paginationControls.classList.remove('hidden');

        // B. Hitung Pagination
        const totalData = filteredUsers.length;
        const maxPage = Math.ceil(totalData / userRowsPerPage);
        
        if (currentUserPage > maxPage) currentUserPage = maxPage;
        if (currentUserPage < 1) currentUserPage = 1;

        const startIndex = (currentUserPage - 1) * userRowsPerPage;
        const endIndex = Math.min(startIndex + userRowsPerPage, totalData);
        
        const pageData = filteredUsers.slice(startIndex, endIndex);

        // C. Generate HTML Baris
        let rowsHtml = pageData.map((u, i) => {
            const realIndex = startIndex + i + 1;
            const isActive = String(u.isActive).toUpperCase().trim() === 'TRUE';
            
            const statusBadge = isActive 
                ? `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-50 text-emerald-700 border border-emerald-100 uppercase tracking-wide"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>Aktif</span>`
                : `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-700 border border-red-100 uppercase tracking-wide"><i class="fas fa-ban text-[9px]"></i> Non-Aktif</span>`;
            
            const roleColor = u.role === 'Admin' ? 'text-purple-600 bg-purple-50 border-purple-100' : (u.role === 'Guru' ? 'text-orange-600 bg-orange-50 border-orange-100' : 'text-blue-600 bg-blue-50 border-blue-100');

            return `
            <tr class="user-row hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group">
                <td class="p-4 text-center text-slate-400 text-xs font-bold w-16">${realIndex}</td>
                <td class="p-4">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-slate-500 font-bold text-xs border border-slate-200 shadow-sm uppercase">
                            ${u.username.charAt(0)}
                        </div>
                        <div>
                            <div class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition">${u.username}</div>
                            <div class="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 rounded inline-block mt-0.5">${u.id}</div>
                        </div>
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex flex-col items-start gap-1">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold border uppercase tracking-wider ${roleColor}">${u.role}</span>
                        ${u.role === 'Siswa' ? `<span class="text-xs text-slate-500 font-medium ml-1"><i class="fas fa-layer-group text-slate-300 mr-1"></i>${u.class}</span>` : ''}
                    </div>
                </td>
                <td class="p-4">
                    <div class="group/pass relative w-fit cursor-help">
                        <span class="text-slate-300 text-xs font-mono tracking-widest">••••••</span>
                        <span class="absolute left-0 -top-6 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover/pass:opacity-100 transition pointer-events-none font-mono z-20 shadow-xl whitespace-nowrap">
                            ${u.password}
                            <div class="absolute -bottom-1 left-2 w-2 h-2 bg-slate-800 rotate-45"></div>
                        </span>
                    </div>
                </td>
                <td class="p-4 text-center cursor-pointer hover:opacity-80 transition" onclick="handleToggleUser('${u.id}', '${u.isActive}')" title="Klik untuk Ubah Status">
                    ${statusBadge}
                </td>
                <td class="p-4 pr-6 text-right">
                    <div class="flex justify-end gap-2 opacity-60 group-hover:opacity-100 transition">
                        <button onclick='openUserModal(${JSON.stringify(u)})' class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-white hover:bg-blue-500 border border-transparent hover:shadow-lg transition transform hover:scale-105" title="Edit">
                            <i class="fas fa-pen-to-square"></i>
                        </button>
                        <button onclick="handleDeleteUser('${u.id}')" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-500 hover:text-white hover:bg-red-500 border border-transparent hover:shadow-lg transition transform hover:scale-105" title="Hapus">
                            <i class="fas fa-trash-can"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('');

        // D. Update HTML Tabel
        wrapper.innerHTML = `
        <div class="overflow-x-auto w-full">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-50/80 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm"> 
                        <th class="w-16 text-center pl-6 py-4">No</th> 
                        <th class="py-4 px-4">Identitas</th>
                        <th class="py-4 px-4">Role & Kelas</th>
                        <th class="py-4 px-4">Password</th>
                        <th class="text-center py-4 px-4">Status</th>
                        <th class="text-right pr-6 py-4 px-4">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">${rowsHtml}</tbody>
            </table>
        </div>`;

        // E. Update Info Pagination
        infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;
        
        btnPrev.disabled = (currentUserPage === 1);
        btnNext.disabled = (currentUserPage === maxPage || maxPage === 0);
        
        // Styling button disabled
        [btnPrev, btnNext].forEach(btn => {
            if(btn.disabled) btn.classList.add('opacity-50', 'cursor-not-allowed');
            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    // --- MODAL & FORM LOGIC ---
function createUserModalHTML() {
    const modalHtml = `
    <div id="modal-user" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeUserModal()"></div>
        
        <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col animate-[fadeIn_0.3s_ease-out] z-[101]">
    
            <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold text-lg text-slate-800" id="modal-user-title">Tambah User</h3>
                <button onclick="closeUserModal()" class="text-slate-400 hover:text-red-500 transition w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form onsubmit="handleUserSubmit(event)" class="p-6 space-y-4 max-h-[80vh] overflow-y-auto custom-scrollbar">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">User ID (NIS / NIP)</label>
                        <input type="text" name="userId" id="input-userId" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono font-bold text-slate-600" placeholder="12345678" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role / Peran</label>
                        <select name="role" id="input-role" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-slate-50 cursor-pointer" onchange="toggleUserClassInput(this.value)">
                            <option value="Siswa">Siswa</option>
                            <option value="Guru">Guru</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Lengkap</label>
                    <input type="text" name="username" id="input-username" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="Contoh: Budi Santoso" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="text" name="password" id="input-password" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm" placeholder="Minimal 6 karakter" required>
                </div>

              <div id="field-class-student" class="hidden">
                  <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas Siswa</label>
                  <select id="input-student-class" class="w-full border border-slate-300 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm bg-white cursor-pointer">
                      <option value="">-- Pilih Kelas --</option>
                      <option value="">Memuat data...</option>
                  </select>
                  <p class="text-[10px] text-slate-400 mt-1">*Data diambil dari Sheet Master_Data (Kolom A).</p>
              </div>

                <div id="field-class-teacher" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-slate-500 uppercase">Tugas Mengajar</label>
                        <button type="button" onclick="addTeacherAssignmentRow()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded font-bold hover:bg-blue-200 transition">
                            <i class="fas fa-plus"></i> Tambah Mapel
                        </button>
                    </div>
                    
                    <div id="teacher-assignments-container" class="space-y-2">
                        </div>
                    <p class="text-[10px] text-slate-400 mt-2">*Pilih Mata Pelajaran dan Kelas yang diajar.</p>
                </div>

                <input type="hidden" name="class" id="final-class-value">

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition active:scale-95 mt-2 flex justify-center items-center gap-2">
                    <i class="fas fa-save"></i> Simpan Data
                </button>
            </form>

        </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function toggleUserClassInput(role) {
    const divStudent = document.getElementById('field-class-student');
    const inputStudent = document.getElementById('input-student-class');
    const divTeacher = document.getElementById('field-class-teacher');
    
    // 1. Reset Tampilan (Sembunyikan Semua)
    divStudent.classList.add('hidden');
    divTeacher.classList.add('hidden');
    
    // Hapus required agar validasi HTML5 tidak error saat disembunyikan
    if(inputStudent) inputStudent.removeAttribute('required');

    // 2. Logika Berdasarkan Role
    if (role === 'Siswa') {
        // Tampilkan Input Siswa
        divStudent.classList.remove('hidden');
        if(inputStudent) inputStudent.setAttribute('required', 'true');
    } 
    else if (role === 'Guru') {
        // Tampilkan Container Guru
        divTeacher.classList.remove('hidden');
        
        // Panggil Data Master (Mapel & Kelas) untuk Dropdown
        loadMasterDataForUser();
        
        // Cek jika container baris mapel masih kosong, tambahkan 1 baris default
        const container = document.getElementById('teacher-assignments-container');
        if (container && container.children.length === 0) {
            addTeacherAssignmentRow();
        }
    }    
}

function openUserModal(data = null) {
    const modal = document.getElementById('modal-user');
    const title = document.getElementById('modal-user-title');
    const idInput = document.getElementById('input-userId');
    const teacherContainer = document.getElementById('teacher-assignments-container');

    // 1. Reset Form & Bersihkan Container
    document.querySelector('form[onsubmit="handleUserSubmit(event)"]').reset();
    if(teacherContainer) teacherContainer.innerHTML = ''; 
    idInput.value = '';
    document.getElementById('final-class-value').value = '';
    
    // 2. Set Default State (Siswa)
    document.getElementById('input-role').value = 'Siswa';
    toggleUserClassInput('Siswa'); // Ini akan menampilkan div siswa

    if (data) {
        // --- MODE EDIT ---
        title.innerText = 'Edit User';
        idInput.value = data.id;
        idInput.readOnly = true; 
        idInput.classList.add('bg-slate-100', 'cursor-not-allowed');
        
        document.getElementById('input-username').value = data.username;
        document.getElementById('input-password').value = data.password;
        document.getElementById('input-role').value = data.role;

        // Ubah tampilan input berdasarkan Role user yang diedit
        toggleUserClassInput(data.role);

        // --- PENGISIAN DATA KELAS ---
        // Jika Siswa, load master data LALU set value-nya
        if (data.role === 'Siswa') {
            // Kita kirim data.class sebagai parameter agar dipilih setelah dropdown ter-render
            loadMasterDataForUser(data.class); 
        } 
        else if (data.role === 'Guru') {
            // Jika Guru, load master data biasa (tanpa select siswa)
            loadMasterDataForUser();

            // Parsing data tugas guru
            const rawAssignments = data.class;
            if (rawAssignments && rawAssignments !== '-' && rawAssignments.trim() !== '') {
                const items = rawAssignments.split(',');
                items.forEach(item => {
                    const parts = item.trim().split(':');
                    if(parts.length >= 2) {
                        addTeacherAssignmentRow(parts[0].trim(), parts[1].trim());
                    }
                });
            } else {
                addTeacherAssignmentRow();
            }
        } else {
            // Jika Admin, tetap pancing load data master untuk jaga-jaga
            loadMasterDataForUser();
        }

    } else {
        // --- MODE TAMBAH BARU ---
        title.innerText = 'Tambah User Baru';
        idInput.readOnly = false;
        idInput.classList.remove('bg-slate-100', 'cursor-not-allowed');
        
        // Load data master kosong (untuk persiapan dropdown)
        loadMasterDataForUser();
    }
    
    // Tampilkan Modal
    modal.classList.remove('hidden');
}

    function closeUserModal() {
        document.getElementById('modal-user').classList.add('hidden');
    }

function handleUserSubmit(e) {
    e.preventDefault();
    
    // --- 1. LOGIKA PERSIAPAN DATA (ROLE & KELAS) ---
    const role = document.getElementById('input-role').value;
    const finalClassInput = document.getElementById('final-class-value');
    
    if (role === 'Siswa') {
        // Jika Siswa, ambil dari dropdown kelas siswa
        finalClassInput.value = document.getElementById('input-student-class').value;
    } 
    else if (role === 'Guru') {
        // Jika Guru, ambil dari baris tugas mengajar
        const rows = document.querySelectorAll('.assignment-row');
        let assignments = [];
        
        rows.forEach(row => {
            const sub = row.querySelector('.assign-subject').value.trim();
            const cls = row.querySelector('.assign-class').value.trim();
            
            if(sub && cls) {
                // Hapus karakter titik dua (:) agar format data bersih
                const cleanSub = sub.replace(/:/g, '');
                const cleanCls = cls.replace(/:/g, '');
                assignments.push(`${cleanSub}:${cleanCls}`);
            }
        });
        
        // Validasi: Guru wajib punya minimal 1 tugas
        if(assignments.length === 0) {
            Swal.fire('Data Tidak Lengkap', 'Guru wajib memiliki minimal satu tugas mengajar.', 'warning');
            return;
        }
        
        finalClassInput.value = assignments.join(', ');
    } 
    else {
        // Jika Admin, kelas diisi strip
        finalClassInput.value = '-'; 
    }

    // --- 2. AMBIL DATA FORM ---
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    
    // Tutup modal & Tampilkan Loading
    closeUserModal();
    document.getElementById('global-loading').classList.remove('hidden');

    // --- 3. LOGIKA PENGIRIMAN KE SERVER (SECURE) ---
    
    // Cek apakah input ID terkunci (ReadOnly). 
    // Jika YA = Mode Edit. Jika TIDAK = Mode Tambah Baru.
    const isEditMode = document.getElementById('input-userId').readOnly;

    if (isEditMode) {
        // --- PROSES UPDATE / EDIT ---
        google.script.run.withSuccessHandler(res => {
            document.getElementById('global-loading').classList.add('hidden');
            if (res.success) { 
                Swal.fire('Berhasil', 'Data user diperbarui.', 'success'); 
                loadUserTable(); 
            } else { 
                Swal.fire('Gagal', res.message, 'error'); 
            }
        })
        // SECURITY PATCH: Kirim ID & Token Admin
        .updateUser(data, currentUser.userID, currentUser.token); 

    } else {
        // --- PROSES CREATE / BARU ---
        google.script.run.withSuccessHandler(res => {
            document.getElementById('global-loading').classList.add('hidden');
            if (res.success) { 
                Swal.fire('Berhasil', 'User baru ditambahkan.', 'success'); 
                loadUserTable(); 
            } else { 
                Swal.fire('Gagal', res.message, 'error'); 
            }
        })
        // SECURITY PATCH: Kirim ID & Token Admin
        .createUser(data, currentUser.userID, currentUser.token); 
    }
}
// KODE BARU (AMAN - SUDAH MENGIRIM KREDENSIAL ADMIN)
function handleDeleteUser(uid) {
    Swal.fire({
        title: 'Hapus User?', 
        text: "Data tidak bisa dikembalikan!", 
        icon: 'warning',
        showCancelButton: true, 
        confirmButtonColor: '#d33', 
        confirmButtonText: 'Ya, Hapus'
    }).then(res => {
        if (res.isConfirmed) {
            document.getElementById('global-loading').classList.remove('hidden');
            
            google.script.run.withSuccessHandler(r => {
                document.getElementById('global-loading').classList.add('hidden');
                if(r.success) { 
                    Swal.fire('Terhapus', '', 'success'); 
                    loadUserTable(); 
                } else { 
                    Swal.fire('Gagal', r.message, 'error'); 
                }
            })
            // --- PERBAIKAN PENTING DISINI ---
            // Kita kirim ID User yang mau dihapus + ID Admin + Token Admin
            .deleteUser(uid, currentUser.userID, currentUser.token); 
        }
    });
}

    function handleToggleUser(uid, status) {
        document.getElementById('global-loading').classList.remove('hidden');
        google.script.run.withSuccessHandler(() => {
            document.getElementById('global-loading').classList.add('hidden');
            loadUserTable();
        }).toggleUserStatus(uid, status);
    }


// ==========================================
    // LOGIKA IMPORT USER EXCEL
    // ==========================================

    function createImportUserModalHTML() {
        const html = `
        <div id="modal-import-user" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeImportUserModal()"></div>
            
            <div class="relative w-full max-w-lg bg-white rounded-2xl shadow-2xl flex flex-col animate-[fadeIn_0.3s_ease-out] z-[101]">
                
                <div class="px-6 py-4 border-b flex justify-between items-center bg-emerald-50 rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-file-excel"></i></div>
                        <h3 class="font-bold text-lg text-emerald-900">Import User dari Excel</h3>
                    </div>
                    <button onclick="closeImportUserModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                </div>

                <div class="p-6 space-y-6">
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600">
                        <p class="font-bold text-slate-800 mb-2"><i class="fas fa-info-circle text-blue-500"></i> Aturan Format Excel:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs ml-1">
                            <li><b>Kolom A (Username):</b> Nama lengkap siswa (Wajib).</li>
                            <li><b>Kolom B (Password):</b> Password akun (Wajib).</li>
                            <li><b>Kolom C (Role):</b> Siswa / Guru / Admin.</li>
                            <li><b>Kolom D (Kelas):</b> Wajib diisi jika role Siswa.</li>
                            <li><b>Kolom E (ID/NIS):</b> Opsional. Jika kosong, ID dibuat otomatis.</li>
                        </ul>
                        <button onclick="downloadUserTemplate()" class="mt-3 text-emerald-600 font-bold hover:underline text-xs flex items-center gap-1">
                            <i class="fas fa-download"></i> Download Template Excel
                        </button>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload File (.xlsx)</label>
                        <input type="file" id="input-user-excel" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500
                          file:mr-4 file:py-2.5 file:px-4
                          file:rounded-xl file:border-0
                          file:text-xs file:font-bold
                          file:bg-emerald-50 file:text-emerald-700
                          hover:file:bg-emerald-100
                          cursor-pointer border border-slate-300 rounded-xl p-2 bg-white transition
                        "/>
                    </div>

                    <button onclick="processUserImport()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold shadow-lg transition active:scale-95 flex justify-center items-center gap-2">
                        <i class="fas fa-upload"></i> Proses Import
                    </button>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', html);
    }

    function openImportUserModal() {
        if (!document.getElementById('modal-import-user')) {
            createImportUserModalHTML();
        }
        document.getElementById('input-user-excel').value = ''; // Reset file
        document.getElementById('modal-import-user').classList.remove('hidden');
    }

    function closeImportUserModal() {
        document.getElementById('modal-import-user').classList.add('hidden');
    }

    // --- FUNGSI DOWNLOAD TEMPLATE OTOMATIS (MENGGUNAKAN SHEETJS) ---
// --- FUNGSI DOWNLOAD TEMPLATE OTOMATIS (MENGGUNAKAN SHEETJS) ---
    function downloadUserTemplate() {
        // Data Dummy untuk Template dengan kolom Mapel dan Kelas terpisah
        const data = [
            ["Username", "Password", "Role", "Mapel", "Kelas", "ID (Opsional)"], // Header Baru
            ["Ahmad Siswa", "123456", "Siswa", "-", "XII-RPL", "1001"], // Contoh Siswa (Mapel kosong/-)
            ["Budi Santoso", "123456", "Siswa", "-", "XII-TKJ", ""],
            ["Pak Guru", "guru123", "Guru", "Matematika", "XII-IPA 1", "GURU-01"], // Contoh Guru
            ["Bu Guru", "guru456", "Guru", "Fisika", "XII-IPA 2", "GURU-02"]
        ];
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // Atur lebar kolom agar rapi
        ws['!cols'] = [{wch:25}, {wch:15}, {wch:10}, {wch:15}, {wch:15}, {wch:15}];
        XLSX.utils.book_append_sheet(wb, ws, "TemplateUser");
        XLSX.writeFile(wb, "Template_Import_User_SIPADU_V2.xlsx");
    }

    // --- FUNGSI PROSES IMPORT ---
// --- FUNGSI PROSES IMPORT ---
    function processUserImport() {
        const fileInput = document.getElementById('input-user-excel');
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire('Peringatan', 'Silakan pilih file Excel terlebih dahulu.', 'warning');
            return;
        }

        // Tampilkan Loading
        closeImportUserModal();
        document.getElementById('global-loading').classList.remove('hidden');

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Ambil sheet pertama
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Ubah ke JSON (Array of Arrays)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                // Format Data agar sesuai dengan Server (Skip Header Baris 0)
                const usersToImport = [];
                // Mulai dari baris ke-1 (indeks 1) karena indeks 0 adalah Header
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length === 0) continue; // Skip baris kosong

                    // Mapping kolom Excel ke Object (SESUAI TEMPLATE BARU)
                    // A=0:Username, B=1:Password, C=2:Role, D=3:Mapel, E=4:Kelas, F=5:ID
                    
                    const role = row[2] ? String(row[2]).trim() : 'Siswa';
                    let classValue = '-';

                    const rawMapel = row[3] ? String(row[3]).trim() : '';
                    const rawKelas = row[4] ? String(row[4]).trim() : '';

                    if (role.toLowerCase() === 'guru') {
                        // Jika Guru, gabungkan Mapel dan Kelas dengan format "Mapel:Kelas"
                        // Contoh: "Matematika:XII-IPA 1"
                        if (rawMapel && rawMapel !== '-' && rawKelas && rawKelas !== '-') {
                            classValue = `${rawMapel}:${rawKelas}`;
                        } else {
                            classValue = '-'; // Atau bisa dikosongkan jika data tidak lengkap
                        }
                    } else {
                        // Jika Siswa, ambil kolom Kelas saja (Kolom E / Index 4)
                        classValue = rawKelas || '-';
                    }

                    usersToImport.push({
                        username: row[0],
                        password: row[1],
                        role: role,
                        class: classValue, // Hasil penggabungan atau nilai kelas
                        id: row[5] // Kolom F (Index 5) adalah ID Opsional
                    });
                }

                if (usersToImport.length === 0) {
                    document.getElementById('global-loading').classList.add('hidden');
                    Swal.fire('Data Kosong', 'Tidak ada data user yang ditemukan di file Excel.', 'info');
                    return;
                }

                // KIRIM KE SERVER
                google.script.run.withSuccessHandler(res => {
                    document.getElementById('global-loading').classList.add('hidden');
                    
                    let msg = `Berhasil import <b>${res.imported}</b> user.`;
                    if(res.failed > 0) {
                        msg += `<br>Gagal/Duplikat: <b class="text-red-500">${res.failed}</b>`;
                        if(res.details.length > 0) {
                            msg += `<div class="mt-2 text-xs text-left bg-red-50 p-2 rounded text-red-700 border border-red-100">Info: ${res.details.join(', ')}...</div>`;
                        }
                    }

                    Swal.fire({
                        title: res.success ? 'Selesai' : 'Gagal',
                        html: msg,
                        icon: res.success ? 'success' : 'error'
                    }).then(() => {
                        loadUserTable(); // Refresh Tabel
                    });

                }).importUsersBulk(usersToImport);

            } catch (err) {
                document.getElementById('global-loading').classList.add('hidden');
                Swal.fire('Error', 'Gagal memproses file Excel: ' + err.message, 'error');
            }
        };

        reader.readAsArrayBuffer(file);
    }
    
/* ==========================================
   HALAMAN FOLDER GAMBAR (BARU)
   ========================================== */

let allImagesData = [];
let filteredImages = [];
let currentImgPage = 1;
let imgRowsPerPage = 10;

function renderImageFolder(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-4">
        
        <div class="dash-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-images text-pink-600"></i> Generator Link Gambar
                    </h2>
                    <p class="text-sm text-slate-500 mt-1">Ubah Folder Google Drive menjadi direct link siap pakai untuk ujian.</p>
                </div>
            </div>

            <div class="bg-pink-50 border border-pink-100 rounded-xl p-4 mb-6">
                <div class="flex gap-4 flex-col md:flex-row">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-pink-700 uppercase mb-2">URL Folder Google Drive</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-pink-400"><i class="fab fa-google-drive"></i></span>
                            <input type="text" id="input-folder-url" placeholder="Paste Link Folder di sini (Pastikan akses folder: Anyone with the link)..." 
                                class="pl-10 w-full border border-pink-200 p-3 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none bg-white transition shadow-sm text-sm">
                        </div>
                    </div>
                    <div class="flex items-end">
                        <button onclick="handleGenerateImages()" class="w-full md:w-auto bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg transition flex items-center justify-center gap-2 transform active:scale-95">
                            <i class="fas fa-magic"></i> Hasilkan Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-card border border-slate-200 overflow-hidden">
             
             <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-700">Riwayat Gambar Tersimpan</h3>
                <button onclick="loadImageTable()" class="text-xs font-bold text-blue-600 hover:underline"><i class="fas fa-sync"></i> Refresh</button>
             </div>

             <div class="p-4 bg-white border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                 
                 <div class="flex items-center gap-2 text-sm text-slate-600">
                      <span>Show</span>
                      <select onchange="changeImgRowsPerPage(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-pink-500 outline-none font-bold text-slate-700 bg-slate-50 cursor-pointer">
                          <option value="10">10</option>
                          <option value="25">25</option>
                          <option value="50">50</option>
                          <option value="100">100</option>
                          <option value="all">Semua</option>
                      </select>
                      <span>entries</span>
                 </div>

                 <div class="relative w-full md:w-64 group">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                        <i class="fas fa-search"></i>
                     </div>
                     <input type="text" placeholder="Cari Nama Gambar..." onkeyup="handleImageSearch(this.value)" 
                            class="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 outline-none transition shadow-sm bg-white">
                 </div>
             </div>
             
             <div id="img-table-container">
                 <div class="flex flex-col items-center justify-center py-12 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-pink-500"></i> Memuat galeri...
                 </div>
             </div>

             <div id="img-pagination-controls" class="p-4 bg-slate-50 border-t border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 text-sm hidden">
                <div class="text-slate-500 font-medium" id="img-pagination-info">Menampilkan 0 - 0 dari 0 data</div>
                <div class="flex gap-2">
                    <button onclick="changeImgPage('prev')" id="btn-img-prev" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Sebelumnya</button>
                    <button onclick="changeImgPage('next')" id="btn-img-next" class="px-4 py-2 border border-slate-300 rounded-lg bg-white hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed transition font-bold text-slate-600">Selanjutnya</button>
                </div>
           </div>
        </div>
    </div>
    `;

    // Load data awal
    loadImageTable();
}

function handleGenerateImages() {
    const url = document.getElementById('input-folder-url').value.trim();
    if (!url) {
        Swal.fire('Peringatan', 'Masukkan Link Folder Google Drive dulu!', 'warning');
        return;
    }

    const btn = document.querySelector('button[onclick="handleGenerateImages()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

    google.script.run.withSuccessHandler(res => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (res.success) {
            Swal.fire('Berhasil', `Ditemukan ${res.count} gambar baru!`, 'success');
            document.getElementById('input-folder-url').value = ''; 
            loadImageTable(); 
        } else {
            Swal.fire('Gagal', res.message, 'error');
        }
    }).processFolderImages(url);
}

function loadImageTable() {
    // Tampilkan loading saat refresh manual
    const container = document.getElementById('img-table-container');
    container.innerHTML = `<div class="flex flex-col items-center justify-center py-12 text-slate-400"><i class="fas fa-circle-notch fa-spin text-3xl mb-2 text-pink-500"></i> Memuat galeri...</div>`;
    document.getElementById('img-pagination-controls').classList.add('hidden');

    google.script.run.withSuccessHandler(data => {
        allImagesData = data || [];
        filteredImages = data || []; // Reset filter
        currentImgPage = 1;          // Reset page
        
        // Reset Search Input
        const searchInput = document.querySelector('input[placeholder="Cari Nama Gambar..."]');
        if(searchInput) searchInput.value = '';

        renderImageTableInternal();
    }).getSavedImages();
}

// --- LOGIKA FILTER & PAGINATION ---

function handleImageSearch(keyword) {
    const term = keyword.toLowerCase().trim();
    // Filter data global
    filteredImages = allImagesData.filter(img => {
        return img.name.toLowerCase().includes(term);
    });
    currentImgPage = 1; // Reset ke halaman 1
    renderImageTableInternal();
}

function changeImgRowsPerPage(val) {
    if (val === 'all') {
        imgRowsPerPage = filteredImages.length > 0 ? filteredImages.length : 10;
    } else {
        imgRowsPerPage = parseInt(val);
    }
    currentImgPage = 1; 
    renderImageTableInternal();
}

function changeImgPage(direction) {
    const maxPage = Math.ceil(filteredImages.length / imgRowsPerPage);
    if (direction === 'prev') {
        if (currentImgPage > 1) currentImgPage--;
    } else if (direction === 'next') {
        if (currentImgPage < maxPage) currentImgPage++;
    }
    renderImageTableInternal();
}

function renderImageTableInternal() {
    const container = document.getElementById('img-table-container');
    const paginationControls = document.getElementById('img-pagination-controls');
    const infoDisplay = document.getElementById('img-pagination-info');
    const btnPrev = document.getElementById('btn-img-prev');
    const btnNext = document.getElementById('btn-img-next');

    // Cek Data Kosong
    if (filteredImages.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-16 text-slate-400">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                    <i class="far fa-images text-2xl text-slate-300"></i>
                </div>
                <p>Data tidak ditemukan.</p>
            </div>`;
        paginationControls.classList.add('hidden');
        return;
    }

    paginationControls.classList.remove('hidden');

    // Hitung Pagination
    const totalData = filteredImages.length;
    const maxPage = Math.ceil(totalData / imgRowsPerPage);
    
    // Validasi Halaman
    if (currentImgPage > maxPage) currentImgPage = maxPage;
    if (currentImgPage < 1) currentImgPage = 1;

    // Slice Data
    const startIndex = (currentImgPage - 1) * imgRowsPerPage;
    const endIndex = Math.min(startIndex + imgRowsPerPage, totalData);
    const pageData = filteredImages.slice(startIndex, endIndex);

    // Generate HTML Baris
    let rowsHtml = pageData.map((img, i) => {
        const realIndex = startIndex + i + 1;
        return `
        <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0 group">
            <td class="p-4 text-center text-slate-400 text-xs w-12">${realIndex}</td>
            <td class="p-4 w-20">
                <div class="w-12 h-12 rounded-lg bg-slate-100 border border-slate-200 overflow-hidden relative group-hover:scale-110 transition cursor-pointer" onclick="window.open('${img.link}', '_blank')">
                    <img src="${img.link}" referrerpolicy="no-referrer" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/50?text=Error'">
                </div>
            </td>
            <td class="p-4">
                <div class="font-bold text-slate-700 text-sm truncate max-w-[250px]" title="${img.name}">${img.name}</div>
                <div class="text-[10px] text-slate-400 mt-1"><i class="far fa-clock"></i> ${img.date}</div>
            </td>
            <td class="p-4">
                <div class="flex items-center gap-2 bg-slate-100 p-2 rounded border border-slate-200 relative group/link">
                    <input type="text" value="${img.link}" readonly class="bg-transparent text-xs text-slate-600 font-mono w-full outline-none select-all" id="link-${realIndex}">
                    <button onclick="copyLink('link-${realIndex}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs px-2 py-1 rounded hover:bg-blue-100 transition" title="Copy Link">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </td>
            <td class="p-4 text-right">
                <button onclick="deleteImage('${img.id}')" class="text-slate-400 hover:text-red-600 hover:bg-red-50 p-2 rounded transition" title="Hapus dari list">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        </tr>`;
    }).join('');

    // Render Tabel Lengkap
    container.innerHTML = `
    <div class="overflow-x-auto w-full">
        <table class="w-full text-left border-collapse">
            <thead class="sticky top-0 z-10">
                <tr class="bg-slate-50/90 border-b border-slate-200 text-slate-500 text-[11px] font-bold uppercase tracking-widest backdrop-blur-sm shadow-sm">
                    <th class="py-3 px-4 text-center">No</th>
                    <th class="py-3 px-4">Preview</th>
                    <th class="py-3 px-4">Nama File</th>
                    <th class="py-3 px-4 w-1/2">Direct Link (Copy Ini)</th>
                    <th class="py-3 px-4 text-right">Aksi</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 bg-white text-sm">
                ${rowsHtml}
            </tbody>
        </table>
    </div>`;

    // Update Info Pagination & Tombol
    infoDisplay.innerText = `Menampilkan ${startIndex + 1} - ${endIndex} dari ${totalData} data`;

    btnPrev.disabled = (currentImgPage === 1);
    if(currentImgPage === 1) btnPrev.classList.add('opacity-50', 'cursor-not-allowed');
    else btnPrev.classList.remove('opacity-50', 'cursor-not-allowed');

    btnNext.disabled = (currentImgPage === maxPage || maxPage === 0);
    if(currentImgPage === maxPage || maxPage === 0) btnNext.classList.add('opacity-50', 'cursor-not-allowed');
    else btnNext.classList.remove('opacity-50', 'cursor-not-allowed');
}

function copyLink(elementId) {
    const copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999); 
    navigator.clipboard.writeText(copyText.value).then(() => {
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
        Toast.fire({ icon: 'success', title: 'Link disalin!' });
    });
}

function deleteImage(id) {
    Swal.fire({
        title: 'Hapus?', text: "Hanya menghapus dari list database, file di Google Drive tetap aman.", icon: 'warning',
        showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus'
    }).then(res => {
        if(res.isConfirmed) {
            google.script.run.withSuccessHandler(r => {
                if(r.success) loadImageTable();
                else Swal.fire('Gagal', r.message, 'error');
            }).deleteSavedImage(id);
        }
    });
}

/* --- FUNGSI TOGGLE PASSWORD VISIBILITY --- */
function togglePasswordVisibility() {
    const passInput = document.getElementById('password');
    const icon = document.getElementById('icon-toggle-pass');

    if (passInput.type === 'password') {
        // Ubah menjadi text (Tampilkan)
        passInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash'); // Ikon mata dicoret
    } else {
        // Kembalikan ke password (Sembunyikan)
        passInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye'); // Ikon mata biasa
    }
}

/* --- HALAMAN KONFIGURASI --- */
/* --- HALAMAN KONFIGURASI (LENGKAP) --- */
function renderConfigPage(container) {
    container.innerHTML = `
    <div class="fade-in w-full space-y-6">
        <div class="dash-card p-6">
            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-4">
                <i class="fas fa-sliders-h text-slate-600"></i> Konfigurasi Aplikasi
            </h2>
            <p class="text-sm text-slate-500 mb-6">Ubah tampilan halaman login aplikasi (Logo, Judul, & Background).</p>

            <form onsubmit="handleSaveConfig(event)" class="space-y-6 max-w-3xl">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Nama Aplikasi (Judul Login)</label>
                    <input type="text" name="appName" id="cfg-app-name" placeholder="Contoh: Ujian Sekolah" 
                        class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition font-bold text-slate-700">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Deskripsi / Sub-Judul</label>
                    <input type="text" name="appSubtitle" id="cfg-app-subtitle" placeholder="Contoh: Tahun Ajaran 2024/2025" 
                        class="w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm">
                </div>

                <div class="border-t border-slate-100 my-4"></div>

                <div class="flex flex-col md:flex-row gap-6">
                    <div class="flex-1 relative group">
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-2">URL Logo Aplikasi (Auto-Search)</label>
                         
                         <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none">
                                <i class="fas fa-search"></i>
                            </span>
                            
                            <input type="text" name="appLogo" id="cfg-app-logo" 
                                placeholder="Ketik nama file gambar..." 
                                autocomplete="off"
                                onkeyup="handleConfigLogoSearch(this)"
                                onfocus="handleConfigLogoSearch(this)"
                                onblur="setTimeout(() => document.getElementById('cfg-logo-results').classList.add('hidden'), 200)"
                                oninput="updateLogoPreview(this.value)"
                                class="pl-10 w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono">
                            
                            <div id="cfg-logo-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                         </div>
                         <p class="text-[10px] text-slate-400 mt-2">*Ketik nama file untuk mencari gambar dari Folder Gambar.</p>
                    </div>
                    
                    <div class="w-24 h-24 bg-slate-100 rounded-xl border border-slate-200 flex items-center justify-center p-2 shrink-0 relative">
                        <img id="cfg-logo-preview" src="" class="max-w-full max-h-full object-contain" onerror="this.style.display='none'">
                        <span class="text-[10px] text-slate-400 absolute z-0">Preview</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-6 pt-2">
                    <div class="flex-1 relative group">
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-2">URL Background Login (Auto-Search)</label>
                         
                         <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 pointer-events-none">
                                <i class="fas fa-image"></i>
                            </span>
                            
                            <input type="text" name="appBackground" id="cfg-app-bg" 
                                placeholder="Ketik nama file gambar..." 
                                autocomplete="off"
                                onkeyup="handleConfigBgSearch(this)"
                                onfocus="handleConfigBgSearch(this)"
                                onblur="setTimeout(() => document.getElementById('cfg-bg-results').classList.add('hidden'), 200)"
                                oninput="updateBgPreview(this.value)"
                                class="pl-10 w-full border border-slate-300 p-3 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-mono">
                            
                            <div id="cfg-bg-results" class="hidden absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 rounded-xl shadow-xl max-h-56 overflow-y-auto custom-scrollbar"></div>
                         </div>
                         <p class="text-[10px] text-slate-400 mt-2">*Disarankan gambar orientasi Landscape.</p>
                    </div>
                    
                    <div class="w-32 h-24 bg-slate-100 rounded-xl border border-slate-200 flex items-center justify-center overflow-hidden shrink-0 relative">
                        <img id="cfg-bg-preview" src="" class="w-full h-full object-cover" onerror="this.style.display='none'">
                        <span class="text-[10px] text-slate-400 absolute z-0">Preview</span>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>`;

    // Panggil fungsi load data saat form selesai dirender
    loadConfigToForm();
}

function updateLogoPreview(url) {
    const img = document.getElementById('cfg-logo-preview');
    img.style.display = 'block';
    img.src = url;
}

/* ==========================================
   LOGIKA KONFIGURASI
   ========================================== */

// 1. Load Data ke Form Konfigurasi (Saat Menu Diklik)
function loadConfigToForm() {
    // Panggil fungsi di Code.gs
    google.script.run.withSuccessHandler(res => {
        if(res.success && res.data) {
            // 1. Isi Input Nama & Subjudul
            document.getElementById('cfg-app-name').value = res.data.app_name || '';
            document.getElementById('cfg-app-subtitle').value = res.data.app_subtitle || '';
            
            // 2. Isi Input Logo & Update Preview
            document.getElementById('cfg-app-logo').value = res.data.app_logo || '';
            updateLogoPreview(res.data.app_logo || '');

            // 3. Isi Input Background & Update Preview
            document.getElementById('cfg-app-bg').value = res.data.app_background || '';
            updateBgPreview(res.data.app_background || '');
        }
    }).getAppConfig();
}

// 2. Simpan Data dari Form
function handleSaveConfig(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

    const fd = new FormData(e.target);
    const formObj = Object.fromEntries(fd.entries());

    google.script.run.withSuccessHandler(res => {
        btn.disabled = false;
        btn.innerHTML = originalText;

        if (res.success) {
            Swal.fire('Berhasil', res.message, 'success');
            // Terapkan langsung perubahan ke tampilan saat ini (Live Update)
            applyConfigToLogin(formObj.appName, formObj.appSubtitle, formObj.appLogo);
        } else {
            Swal.fire('Gagal', res.message, 'error');
        }
    }).saveAppConfig(formObj);
}

// 3. Terapkan Konfigurasi ke Halaman Login (Dipanggil saat awal Load & setelah Save)
function applyConfigToLogin(title, subtitle, logo) {
    if (title) {
        document.getElementById('login-title').innerText = title;
        // Juga ubah Title Header Admin
        const adminHeader = document.querySelector('.sidebar-header-text h1');
        if(adminHeader) adminHeader.innerText = title;
        // Ubah Title Browser Tab
        document.title = title; 
    }
    if (subtitle) document.getElementById('login-subtitle').innerText = subtitle;
    if (logo) {
        document.getElementById('login-logo-img').src = logo;
    }
}

// --- FUNGSI MEMBUKA MODAL UJIAN (REVISI FIX SUBMIT) ---
function openExamModal(data = null) {
    const modal = document.getElementById('examModal'); 
    
    // Safety check: Init jika modal belum ada
    if (!modal) {
        initExamModalComponent();
        return setTimeout(() => openExamModal(data), 50);
    }

    const title = document.getElementById('examModalTitle');
    const btn = document.getElementById('btnSaveExam');
    
    // 1. Reset Form
    document.getElementById('examForm').reset();
    document.getElementById('input-examId').value = '';

    // 2. Helper Format Tanggal
    const toLocalISO = (dateStr) => {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
        return local.toISOString().slice(0, 16);
    };

    // 3. Isi Data Input Standar (Non-Dropdown)
    if (data) {
        title.innerText = 'Edit Jadwal Ujian';
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Data';
        document.getElementById('input-examId').value = data.id;
        document.getElementById('input-date').value = toLocalISO(data.date); 
        document.getElementById('input-endDate').value = toLocalISO(data.endDate);
        document.getElementById('input-duration').value = data.duration;
        document.getElementById('input-pin').value = data.pin;
    } else {
        title.innerText = 'Buat Jadwal Baru';
        btn.innerHTML = '<i class="fas fa-save"></i> Simpan Jadwal';
        const now = new Date();
        const next = new Date(now.getTime() + 2 * 60 * 60 * 1000); 
        document.getElementById('input-date').value = toLocalISO(now);
        document.getElementById('input-endDate').value = toLocalISO(next);
        document.getElementById('input-duration').value = '60'; 
        document.getElementById('input-pin').value = Math.floor(10000 + Math.random() * 90000);
    }

    // 4. LOGIKA DROPDOWN (DIPERBAIKI)
    const subjSelect = document.getElementById('input-subject');
    const classSelect = document.getElementById('input-class');

    // Fungsi kecil untuk memilih value pada dropdown
    const applySelection = () => {
        if (data) {
            subjSelect.value = data.subject || "";
            classSelect.value = data.class || "";
        } else {
            subjSelect.value = "";
            classSelect.value = "";
        }
    };
    
    // Cek apakah dropdown perlu diisi (Fetch Server) atau sudah ada isinya (Cache)
    if (subjSelect.options.length <= 1) { 
        // --- KONDISI A: Dropdown Kosong -> Ambil dari Server ---
        subjSelect.innerHTML = '<option>Loading...</option>';
        classSelect.innerHTML = '<option>Loading...</option>';
        
        let serverFunction = 'getAllTeacherAssignments'; 
        if (typeof currentUser !== 'undefined' && currentUser.role === 'Guru') {
            serverFunction = 'getTeacherAssignments'; 
        }

        google.script.run
            .withSuccessHandler((assignments) => {
                // Reset Option
                subjSelect.innerHTML = '<option value="">-- Pilih Mapel --</option>';
                classSelect.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                
                const subjects = new Set();
                const classes = new Set();

                // Kumpulkan Data Unik
                assignments.forEach(item => {
                    if(item.subject) subjects.add(item.subject);
                    if(item.classVal) classes.add(item.classVal);
                });

                // Isi Option Mapel
                subjects.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.innerText = s;
                    subjSelect.appendChild(opt);
                });

                // Isi Option Kelas
                classes.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    classSelect.appendChild(opt);
                });

                // --- PENTING: SETELAH ISI, LANGSUNG PILIH VALUE ---
                applySelection();
            })
            .withFailureHandler((err) => {
                console.error(err);
                subjSelect.innerHTML = '<option value="">Gagal</option>';
                classSelect.innerHTML = '<option value="">Gagal</option>';
            })[serverFunction](currentUser ? currentUser.userID : null, currentUser ? currentUser.token : null);

    } else {
        // --- KONDISI B: Dropdown Sudah Ada Isinya -> Langsung Pilih Value ---
        // (Sebelumnya bagian ini tidak ada, makanya value tidak terpilih saat buka kedua kali)
        applySelection();
    }

    modal.classList.remove('hidden');
}

// --- FUNGSI BANTUAN RENDER DROPDOWN (Dipakai Guru & Admin) ---
function renderAssignmentDropdown(items, editData, emptyLabel) {
    const wrapper = document.getElementById('assignment-wrapper');
    if(!wrapper) return;

    if (!items || items.length === 0) {
        wrapper.innerHTML = `<div class="text-red-500 text-xs p-2 font-bold bg-red-50 rounded border border-red-200">Belum ada data (${emptyLabel}) di Database Users.</div>`;
    } else {
        // Buat Opsi Dropdown
        let options = items.map(a => `<option value="${a.subject}|${a.classVal}">${a.label}</option>`).join('');
        
        // Render Select
        wrapper.outerHTML = `
            <select id="select-assignment" onchange="fillAssignmentInput(this)" class="w-full border border-blue-300 bg-blue-50 text-blue-900 p-2.5 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition text-sm font-bold cursor-pointer" required>
                <option value="">-- Pilih Mapel & Kelas --</option>
                ${options}
            </select>`;

        // Jika Mode Edit, pilih nilai yang sesuai
        if (editData) {
            const valToSelect = `${editData.subject}|${editData.class}`;
            const selectEl = document.getElementById('select-assignment');
            if(selectEl) {
                selectEl.value = valToSelect;
                fillAssignmentInput(selectEl); // Trigger manual agar hidden input terisi
            }
        }
    }
}

// --- FUNGSI PENGISI INPUT HIDDEN ---
function fillAssignmentInput(selectElement) {
    const val = selectElement.value;
    const inputSub = document.getElementById('input-subject');
    const inputCls = document.getElementById('input-class');
    
    if (val && val.includes('|')) {
        const parts = val.split('|');
        inputSub.value = parts[0]; // Isi Mapel ke hidden
        inputCls.value = parts[1]; // Isi Kelas ke hidden
    } else {
        inputSub.value = '';
        inputCls.value = '';
    }
}


function loadMasterDataForUser(selectedClass = null) {
    // Cek jika data belum ada, ambil dari server
    if (masterData.classes.length === 0) {
        google.script.run.withSuccessHandler(res => {
            masterData = res;
            
            // 1. Render Dropdown Kelas Siswa
            renderStudentClassDropdown(selectedClass);

            // 2. Render Baris Guru (Jika sedang membuka tab Guru)
            const role = document.getElementById('input-role').value;
            if (role === 'Guru') {
                renderTeacherRows(); 
            }
        }).getMasterData();
    } else {
        // Jika data sudah ada di cache, langsung render
        renderStudentClassDropdown(selectedClass);
    }
}


function renderStudentClassDropdown(selectedValue = null) {
    const select = document.getElementById('input-student-class');
    if (!select) return;

    // Reset opsi
    select.innerHTML = '<option value="">-- Pilih Kelas --</option>';

    // Loop data master kelas
    if (masterData && masterData.classes) {
        masterData.classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            
            // Pilih otomatis jika ada value yang dikirim (Mode Edit)
            if (selectedValue && String(c) === String(selectedValue)) {
                opt.selected = true;
            }
            select.appendChild(opt);
        });
    }
}

/* --- FUNGSI BARU: RENDER BARIS PENUGASAN GURU --- */
function addTeacherAssignmentRow(subjectVal = '', classVal = '') {
    const container = document.getElementById('teacher-assignments-container');
    
    // Siapkan Opsi Dropdown Mapel
    let subOpts = `<option value="">- Pilih Mapel -</option>`;
    masterData.subjects.forEach(s => {
        subOpts += `<option value="${s}" ${s === subjectVal ? 'selected' : ''}>${s}</option>`;
    });

    // Siapkan Opsi Dropdown Kelas
    let clsOpts = `<option value="">- Pilih Kelas -</option>`;
    masterData.classes.forEach(c => {
        clsOpts += `<option value="${c}" ${c === classVal ? 'selected' : ''}>${c}</option>`;
    });

    // Tambahkan Input Text Manual sebagai fallback jika opsi tidak ada
    const div = document.createElement('div');
    div.className = 'assignment-row flex gap-2 items-center animate-[fadeIn_0.2s_ease-out]';
    div.innerHTML = `
        <div class="flex-1 relative">
            <input type="text" list="dl-subjects" class="assign-subject w-full border border-slate-300 rounded px-2 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Mapel" value="${subjectVal}">
            <datalist id="dl-subjects">${subOpts}</datalist>
        </div>
        <div class="w-1/3 relative">
            <input type="text" list="dl-classes" class="assign-class w-full border border-slate-300 rounded px-2 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Kelas" value="${classVal}">
            <datalist id="dl-classes">${clsOpts}</datalist>
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="text-slate-400 hover:text-red-500 px-1 transition"><i class="fas fa-trash"></i></button>
    `;
    container.appendChild(div);
}
// --- HELPER PAGINATION & FILTER ---

function handleResultSearch(keyword) {
    const term = keyword.toLowerCase().trim();
    
    // Filter data mentah (allResultsData)
    filteredResults = allResultsData.filter(item => {
        return item.name.toLowerCase().includes(term) || 
               item.studentId.toLowerCase().includes(term);
    });

    currentPage = 1; // Reset ke halaman 1 setiap pencarian
    renderInternalTable(); // Render ulang
}

function changeRowsPerPage(val) {
    if (val === 'all') {
        rowsPerPage = filteredResults.length > 0 ? filteredResults.length : 10;
    } else {
        rowsPerPage = parseInt(val);
    }
    currentPage = 1; // Reset ke halaman 1
    renderInternalTable();
}

function changePage(direction) {
    if (direction === 'prev') {
        if (currentPage > 1) currentPage--;
    } else if (direction === 'next') {
        const maxPage = Math.ceil(filteredResults.length / rowsPerPage);
        if (currentPage < maxPage) currentPage++;
    }
    renderInternalTable();
}
    function switchPage(pid) {
       document.querySelectorAll('#app > div').forEach(d => { if(!d.id.includes('overlay')) d.classList.add('hidden'); });
       document.getElementById(pid).classList.remove('hidden');
    }
  </script>
</body>
</html>